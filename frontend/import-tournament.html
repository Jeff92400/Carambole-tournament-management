<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import Tournoi - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/FrenchBillard-Icon-small.png">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/branding.js?v=197"></script>
  <style>
    .phase-upload-zone {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }
    .phase-zone-header {
      background: var(--color-primary, #1F4788);
      color: #fff;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 600;
    }
    .phase-zone-droparea {
      border: 2px dashed #ccc;
      border-radius: 0 0 6px 6px;
      margin: 8px;
      padding: 16px 12px;
      text-align: center;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }
    .phase-zone-droparea:hover,
    .phase-zone-droparea.dragover {
      background: #f0f4ff;
      border-color: var(--color-primary, #1F4788);
    }
    .phase-zone-files {
      padding: 0 8px 8px 8px;
    }
    .phase-zone-files:empty {
      padding: 0;
    }
    .phase-file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      background: #f8f9fa;
      border-radius: 5px;
      margin-bottom: 4px;
      font-size: 12px;
    }
    .phase-file-item span {
      flex: 1;
    }
    .phase-file-item button {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      font-size: 14px;
      padding: 0 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img id="app-header-icon" src="images/FrenchBillard-Icon-small.png" alt="" style="height: 48px; width: 48px; vertical-align: middle; margin-right: 8px;" onerror="this.src='images/FrenchBillard-Icon-small.png';"><span id="app-org-name" data-page-title="Import Comp√©tition">CDB</span></h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html" class="nav-tooltip" data-tooltip="Classement par cat√©gorie de jeu au fur et √† mesure des tournois">Classements</a>
        <a href="generate-poules.html" class="nav-tooltip" data-tooltip="Comp√©titions √† jouer / Convocations">Comp√©titions</a>
        <a href="calendar.html" class="nav-tooltip" data-tooltip="Calendrier de la saison">Calendrier</a>
        <a href="emailing.html" class="nav-tooltip" data-tooltip="Annonces, relances, r√©sultats, convocation">Com joueurs</a>
        <a href="settings.html" class="admin-only nav-tooltip" data-tooltip="R√©serv√© aux administrateurs">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div class="card">
      <!-- Tab selector -->
      <div id="importTabs" style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
        <button class="import-tab active" data-tab="standard" onclick="switchImportTab('standard')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--color-primary, #1F4788); border-bottom: 2px solid var(--color-primary, #1F4788); margin-bottom: -2px;">
          Import R√©sultats CSV
        </button>
        <button class="import-tab" data-tab="matches" onclick="switchImportTab('matches')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; font-size: 14px; font-weight: 500; color: #999; border-bottom: 2px solid transparent; margin-bottom: -2px;">
          Import Matchs E2i
        </button>
      </div>

      <!-- ===== STANDARD IMPORT TAB ===== -->
      <div id="tabStandard">
        <h3 id="importCardTitle">Enregistrer les resultats d'une competition</h3>
        <p id="importCardDescription" style="color: #666; margin-bottom: 20px;">
          Selectionnez la categorie, le numero du tournoi et la saison, puis importez le fichier CSV des resultats.
        </p>

        <form id="importForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="modeSelect">Mode de jeu *</label>
              <select id="modeSelect" required>
                <option value="">-- S√©lectionner --</option>
              </select>
            </div>
            <div class="form-group">
              <label for="levelSelect">Classement FFB *</label>
              <select id="levelSelect" required>
                <option value="">-- S√©lectionner --</option>
              </select>
              <!-- Hidden select to store the resolved category ID -->
              <select id="categorySelect" style="display: none;">
                <option value="">-- S√©lectionner une cat√©gorie --</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="tournamentNumber">Num√©ro du tournoi *</label>
            <select id="tournamentNumber" required>
              <option value="">-- S√©lectionner --</option>
            </select>
          </div>

          <div class="form-group">
            <label for="tournamentDate">Date du tournoi *</label>
            <input type="date" id="tournamentDate" required>
          </div>

          <div class="form-group">
            <label for="season">Saison (calcul√©e automatiquement)</label>
            <input type="text" id="season" placeholder="Ex: 2024-2025" readonly style="background: #f0f0f0;">
          </div>

          <!-- Single file upload zone (standard mode) -->
          <div class="file-upload" id="fileUpload">
            <p>üìÅ Cliquez pour s√©lectionner un fichier CSV</p>
            <p style="font-size: 12px; color: #999; margin-top: 10px;">ou glissez-d√©posez le fichier ici</p>
            <input type="file" id="fileInput" accept=".csv" required>
            <div id="fileName" class="file-name" style="display: none;"></div>
          </div>

          <button type="submit" class="btn" id="importBtn">Enregistrer la competition</button>
        </form>
      </div>

      <!-- ===== MATCHES E2i IMPORT TAB ===== -->
      <div id="tabMatches" style="display: none;">
        <h3>Import des matchs depuis E2i</h3>
        <p style="color: #666; margin-bottom: 20px;">
          Importez les fichiers CSV de matchs export√©s depuis E2i/telemat.org. D√©posez chaque fichier dans la zone correspondant √† sa phase.
        </p>

        <form id="matchImportForm" onsubmit="return false;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="matchModeSelect">Mode de jeu *</label>
              <select id="matchModeSelect" required>
                <option value="">-- S√©lectionner --</option>
              </select>
            </div>
            <div class="form-group">
              <label for="matchLevelSelect">Classement FFB *</label>
              <select id="matchLevelSelect" required>
                <option value="">-- S√©lectionner --</option>
              </select>
              <select id="matchCategorySelect" style="display: none;">
                <option value="">--</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="matchTournamentNumber">Num√©ro du tournoi *</label>
            <select id="matchTournamentNumber" required>
              <option value="">-- S√©lectionner --</option>
            </select>
          </div>

          <div class="form-group">
            <label for="matchTournamentDate">Date du tournoi *</label>
            <input type="date" id="matchTournamentDate" required>
          </div>

          <div class="form-group">
            <label for="matchSeason">Saison (calcul√©e automatiquement)</label>
            <input type="text" id="matchSeason" placeholder="Ex: 2025-2026" readonly style="background: #f0f0f0;">
          </div>

          <!-- Phase-based upload zones -->
          <div id="phaseUploadGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <!-- Zone 1: Poules (always visible) -->
            <div class="phase-upload-zone" data-phase="POULE">
              <div class="phase-zone-header">Poules</div>
              <div class="phase-zone-droparea" id="zone-POULE">
                <p style="margin: 0; font-size: 13px; color: #666;">Fichiers CSV des poules (A, B, C...)</p>
                <p style="font-size: 11px; color: #999; margin: 6px 0 0 0;">Cliquez ou glissez-d√©posez</p>
                <input type="file" accept=".csv" multiple style="display: none;">
              </div>
              <div class="phase-zone-files" id="files-POULE"></div>
            </div>
            <!-- Zone 2: Demi-finales (journ√©es only) -->
            <div class="phase-upload-zone phase-zone-bracket" data-phase="DEMI-FINALE" style="display: none;">
              <div class="phase-zone-header">Demi-finales</div>
              <div class="phase-zone-droparea" id="zone-DEMI-FINALE">
                <p style="margin: 0; font-size: 13px; color: #666;">Fichier(s) CSV des demi-finales</p>
                <p style="font-size: 11px; color: #999; margin: 6px 0 0 0;">Cliquez ou glissez-d√©posez</p>
                <input type="file" accept=".csv" multiple style="display: none;">
              </div>
              <div class="phase-zone-files" id="files-DEMI-FINALE"></div>
            </div>
            <!-- Zone 3: Finale / Petite Finale (journ√©es only) -->
            <div class="phase-upload-zone phase-zone-bracket" data-phase="FINALE" style="display: none;">
              <div class="phase-zone-header">Finale / Petite Finale</div>
              <div class="phase-zone-droparea" id="zone-FINALE">
                <p style="margin: 0; font-size: 13px; color: #666;">Fichiers CSV de la finale et petite finale</p>
                <p style="font-size: 11px; color: #999; margin: 6px 0 0 0;">Cliquez ou glissez-d√©posez</p>
                <input type="file" accept=".csv" multiple style="display: none;">
              </div>
              <div class="phase-zone-files" id="files-FINALE"></div>
            </div>
            <!-- Zone 4: Classement (journ√©es only) -->
            <div class="phase-upload-zone phase-zone-bracket" data-phase="CLASSEMENT" style="display: none;">
              <div class="phase-zone-header">Classement</div>
              <div class="phase-zone-droparea" id="zone-CLASSEMENT">
                <p style="margin: 0; font-size: 13px; color: #666;">Fichiers CSV de classement (05-06, 07-08...)</p>
                <p style="font-size: 11px; color: #999; margin: 6px 0 0 0;">Cliquez ou glissez-d√©posez</p>
                <input type="file" accept=".csv" multiple style="display: none;">
              </div>
              <div class="phase-zone-files" id="files-CLASSEMENT"></div>
            </div>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button type="button" class="btn" id="previewMatchesBtn" onclick="previewMatches()" style="background: #6c757d;">
              Aper√ßu des r√©sultats
            </button>
            <button type="button" class="btn" id="importMatchesBtn" onclick="importMatches()" style="display: none;">
              Importer les matchs
            </button>
          </div>
        </form>

        <!-- Preview table -->
        <div id="matchPreviewCard" style="display: none; margin-top: 20px;">
          <h4 style="margin-bottom: 5px;">Aper√ßu des r√©sultats calcul√©s</h4>
          <p id="matchPreviewInfo" style="color: #666; font-size: 13px; margin-bottom: 15px;"></p>
          <div style="overflow-x: auto;">
            <table id="matchPreviewTable" class="data-table" style="font-size: 12px; width: 100%;">
              <thead id="matchPreviewHead"></thead>
              <tbody id="matchPreviewBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="resultsCard" style="display: none;">
      <h3>R√©sultats de l'import</h3>
      <div id="importResults"></div>
    </div>

    <!-- Modal for unknown players -->
    <div id="unknownPlayersModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0;">‚ö†Ô∏è Joueurs inconnus d√©tect√©s</h3>
        <p style="color: #666; margin-bottom: 20px;">Les joueurs suivants n'existent pas dans la base de donn√©es. Veuillez s√©lectionner leur club pour les cr√©er.</p>
        <div id="unknownPlayersList"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button id="createPlayersBtn" class="btn" style="flex: 1;">Cr√©er les joueurs et continuer</button>
          <button id="cancelBtn" class="btn" style="flex: 1; background: #999;">Annuler</button>
        </div>
      </div>
    </div>

    <!-- Modal for existing tournament warning -->
    <div id="existingTournamentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0; color: #dc3545;">‚ö†Ô∏è Tournoi existant</h3>
        <p style="color: #666; margin-bottom: 15px;">Un tournoi existe d√©j√† pour cette cat√©gorie/num√©ro/saison :</p>
        <div id="existingTournamentInfo" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
        </div>
        <p style="color: #dc3545; font-weight: bold; margin-bottom: 20px;">
          En continuant, les r√©sultats existants seront d√©finitivement remplac√©s !
        </p>
        <div style="display: flex; gap: 10px;">
          <button id="confirmOverwriteBtn" class="btn" style="flex: 1; background: #dc3545;">Remplacer le tournoi</button>
          <button id="cancelOverwriteBtn" class="btn" style="flex: 1; background: #6c757d;">Annuler</button>
        </div>
      </div>
    </div>

    <!-- Modal for sending results email -->
    <div id="sendResultsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); text-align: center;">
        <div style="font-size: 48px; margin-bottom: 15px;">üìß</div>
        <h3 style="margin-top: 0; color: #1F4788;">Envoyer les r√©sultats ?</h3>
        <p style="color: #666; margin-bottom: 25px;">
          Voulez-vous envoyer les r√©sultats du tournoi par email aux participants ?
        </p>
        <div style="display: flex; gap: 10px;">
          <button id="sendResultsYesBtn" class="btn" style="flex: 1; background: #28a745;">Oui, envoyer</button>
          <button id="sendResultsNoBtn" class="btn" style="flex: 1; background: #6c757d;">Plus tard</button>
        </div>
        <p style="font-size: 12px; color: #999; margin-top: 15px;">
          Vous pourrez envoyer les r√©sultats plus tard depuis la page Comp√©titions Jou√©es
        </p>
      </div>
    </div>
  </div>

  <script src="js/auth-utils.js?v=197"></script>
  <script src="js/app-branding.js?v=215"></script>
  <script>
    const API_URL = '/api';

    // Check authentication
    if (!requireAuth()) {
      throw new Error('Not authenticated'); // Stop script execution
    }
    const token = localStorage.getItem('token');

    // Check user role - this page is admin only
    const userRole = localStorage.getItem('userRole');
    if (userRole !== 'admin') {
      alert('Acc√®s r√©serv√© aux administrateurs');
      window.location.href = 'dashboard.html';
    }


    // Calculate season from tournament date
    // September to July determines the season
    // Example: Oct 2025 ‚Üí 2025-2026, July 2026 ‚Üí 2025-2026, Sept 2026 ‚Üí 2026-2027
    function calculateSeason(dateString) {
      const date = new Date(dateString);
      const month = date.getMonth() + 1; // 1-12
      const year = date.getFullYear();

      // If month is September (9) or later, season starts this year
      // If month is before September, season started last year
      const startYear = month >= 9 ? year : year - 1;
      const endYear = startYear + 1;

      return `${startYear}-${endYear}`;
    }

    // Update season when tournament date changes
    document.getElementById('tournamentDate').addEventListener('change', (e) => {
      const date = e.target.value;
      if (date) {
        const season = calculateSeason(date);
        document.getElementById('season').value = season;
      }
    });

    // Load categories
    async function loadCategories() {
      try {
        const response = await fetch(`${API_URL}/tournaments/categories`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          categories = await response.json();

          // Populate mode selector with unique game types (both tabs)
          const modes = [...new Set(categories.map(c => c.game_type))].sort();
          const modeOptions = '<option value="">-- S√©lectionner --</option>' +
            modes.map(mode => `<option value="${mode}">${mode}</option>`).join('');
          document.getElementById('modeSelect').innerHTML = modeOptions;
          document.getElementById('matchModeSelect').innerHTML = modeOptions;

          // Keep hidden categorySelect for compatibility
          const select = document.getElementById('categorySelect');
          select.innerHTML = '<option value="">-- S√©lectionner une cat√©gorie --</option>';
          categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.display_name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    // Mode selector change - populate levels
    document.getElementById('modeSelect').addEventListener('change', (e) => {
      const selectedMode = e.target.value;
      const levelSelect = document.getElementById('levelSelect');
      const categorySelect = document.getElementById('categorySelect');

      levelSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      categorySelect.value = '';

      if (selectedMode) {
        // Filter categories by selected mode and get unique levels
        const levels = categories
          .filter(c => c.game_type === selectedMode)
          .map(c => c.level)
          .filter((v, i, a) => a.indexOf(v) === i)
          .sort();

        levels.forEach(level => {
          levelSelect.innerHTML += `<option value="${level}">${level}</option>`;
        });
      }
    });

    // Level selector change - set category
    document.getElementById('levelSelect').addEventListener('change', (e) => {
      const selectedMode = document.getElementById('modeSelect').value;
      const selectedLevel = e.target.value;
      const categorySelect = document.getElementById('categorySelect');

      if (selectedMode && selectedLevel) {
        // Find the matching category
        const matchingCategory = categories.find(c =>
          c.game_type === selectedMode && c.level === selectedLevel
        );
        if (matchingCategory) {
          categorySelect.value = matchingCategory.id;
        }
      } else {
        categorySelect.value = '';
      }

      lookupTournamentDate();
    });

    // Tournament number change ‚Äî also try to auto-fill date
    document.getElementById('tournamentNumber').addEventListener('change', () => {
      lookupTournamentDate();
    });

    // Auto-fill tournament date from tournoi_ext (planned tournaments)
    async function lookupTournamentDate() {
      const mode = document.getElementById('modeSelect').value;
      const level = document.getElementById('levelSelect').value;
      const tournamentNumber = document.getElementById('tournamentNumber').value;

      if (!mode || !level || !tournamentNumber) return;

      try {
        const response = await fetch(
          `${API_URL}/tournaments/lookup-date?mode=${encodeURIComponent(mode)}&categorie=${encodeURIComponent(level)}&tournamentNumber=${encodeURIComponent(tournamentNumber)}`,
          { headers: { 'Authorization': `Bearer ${token}` } }
        );
        if (response.ok) {
          const data = await response.json();
          if (data.found && data.date) {
            document.getElementById('tournamentDate').value = data.date;
            // Trigger season auto-calculation
            document.getElementById('tournamentDate').dispatchEvent(new Event('change'));
          }
        }
      } catch (error) {
        // Silently fail ‚Äî date field remains editable for manual entry
      }
    }

    // File upload handling
    const fileUpload = document.getElementById('fileUpload');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');

    fileUpload.addEventListener('click', () => {
      fileInput.click();
    });

    fileUpload.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUpload.style.background = '#f0f0f0';
    });

    fileUpload.addEventListener('dragleave', () => {
      fileUpload.style.background = '';
    });

    fileUpload.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUpload.style.background = '';

      if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        fileName.textContent = e.dataTransfer.files[0].name;
        fileName.style.display = 'block';
      }
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
        fileName.textContent = fileInput.files[0].name;
        fileName.style.display = 'block';
      }
    });

    // Global variables for import
    let clubs = [];
    let categories = [];
    let unknownPlayers = [];
    let currentFormData = null;
    let isSubmitting = false;

    // Load clubs for dropdown
    async function loadClubs() {
      try {
        const response = await fetch(`${API_URL}/clubs`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          clubs = await response.json();
        }
      } catch (error) {
        console.error('Error loading clubs:', error);
      }
    }

    // Show unknown players modal
    function showUnknownPlayersModal(players) {
      unknownPlayers = players;
      const modal = document.getElementById('unknownPlayersModal');
      const list = document.getElementById('unknownPlayersList');

      list.innerHTML = players.map((player, index) => `
        <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
          <div style="font-weight: bold; margin-bottom: 8px;">
            ${player.fullName} (${player.licence})
          </div>
          <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #666;">Club *</label>
          <select id="club_${index}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">-- S√©lectionner un club --</option>
            ${clubs.map(club => `<option value="${club.name}">${club.display_name}</option>`).join('')}
          </select>
        </div>
      `).join('');

      modal.style.display = 'flex';
    }

    // Hide modal
    function hideModal() {
      document.getElementById('unknownPlayersModal').style.display = 'none';
    }

    // Create players and continue import
    document.getElementById('createPlayersBtn').addEventListener('click', async () => {
      const playersToCreate = unknownPlayers.map((player, index) => {
        const clubSelect = document.getElementById(`club_${index}`);
        if (!clubSelect.value) {
          throw new Error(`Veuillez s√©lectionner un club pour ${player.fullName}`);
        }
        return {
          licence: player.licence,
          firstName: player.firstName,
          lastName: player.lastName,
          club: clubSelect.value
        };
      });

      try {
        // Create players
        const createResponse = await fetch(`${API_URL}/tournaments/create-players`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ players: playersToCreate })
        });

        if (!createResponse.ok) {
          throw new Error('Erreur lors de la cr√©ation des joueurs');
        }

        hideModal();

        // Now proceed with the actual import
        await performImport(currentFormData);

      } catch (error) {
        alert(error.message || 'Erreur lors de la cr√©ation des joueurs');
      }
    });

    // Cancel button
    document.getElementById('cancelBtn').addEventListener('click', () => {
      hideModal();
      document.getElementById('importBtn').disabled = false;
      document.getElementById('importBtn').textContent = 'Enregistrer la competition';
    });

    // Show existing tournament warning modal
    function showExistingTournamentModal(tournament) {
      const modal = document.getElementById('existingTournamentModal');
      const info = document.getElementById('existingTournamentInfo');

      const importDate = tournament.importDate
        ? new Date(tournament.importDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })
        : 'Non renseign√©e';

      info.innerHTML = `
        <p style="margin: 0 0 8px 0;"><strong>${tournament.categoryName}</strong></p>
        <p style="margin: 0 0 8px 0;">Tournoi ${tournament.tournamentNumber} - Saison ${tournament.season}</p>
        <p style="margin: 0 0 8px 0;">Joueurs enregistr√©s : <strong>${tournament.playerCount}</strong></p>
        <p style="margin: 0; font-size: 12px; color: #666;">Import√© le : ${importDate}</p>
      `;

      modal.style.display = 'flex';
    }

    // Hide existing tournament modal
    function hideExistingTournamentModal() {
      document.getElementById('existingTournamentModal').style.display = 'none';
    }

    // Confirm overwrite ‚Äî single handler that dispatches by mode
    // Uses pendingOverwriteAction (set by handleStandardSubmit or handleJourneesSubmit)
    let pendingOverwriteAction = null;
    document.getElementById('confirmOverwriteBtn').addEventListener('click', async () => {
      hideExistingTournamentModal();
      if (pendingOverwriteAction) {
        await pendingOverwriteAction();
        pendingOverwriteAction = null;
      }
    });

    // Cancel overwrite button
    document.getElementById('cancelOverwriteBtn').addEventListener('click', () => {
      hideExistingTournamentModal();
      document.getElementById('importBtn').disabled = false;
      document.getElementById('importBtn').textContent = 'Enregistrer la competition';
    });

    // Check if tournament exists
    async function checkTournamentExists(categoryId, tournamentNumber, season) {
      if (!categoryId || !tournamentNumber || !season) return { exists: false };
      try {
        const response = await fetch(
          `${API_URL}/tournaments/check-exists?categoryId=${categoryId}&tournamentNumber=${tournamentNumber}&season=${encodeURIComponent(season)}`,
          { headers: { 'Authorization': `Bearer ${token}` } }
        );
        if (response.ok) {
          return await response.json();
        }
      } catch (error) {
        console.error('Error checking tournament:', error);
      }
      return { exists: false };
    }

    // Perform the actual import
    async function performImport(formData) {
      const errorDiv = document.getElementById('errorMessage');
      const successDiv = document.getElementById('successMessage');
      const importBtn = document.getElementById('importBtn');

      // Get category ID for the link
      const categoryId = document.getElementById('categorySelect').value;

      try {
        const response = await fetch(`${API_URL}/tournaments/import`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          successDiv.textContent = `Import r√©ussi ! ${data.imported} r√©sultats import√©s. Les classements ont √©t√© recalcul√©s.`;
          successDiv.style.display = 'block';

          // Show results
          const resultsCard = document.getElementById('resultsCard');
          const resultsDiv = document.getElementById('importResults');

          resultsDiv.innerHTML = `
            <div class="stats-grid">
              <div class="stat-card">
                <h4>R√©sultats import√©s</h4>
                <div class="stat-value">${data.imported}</div>
              </div>
            </div>
            <p style="margin-top: 20px;">
              <a href="rankings.html?categoryId=${categoryId}" class="btn btn-small">Voir les classements mis √† jour</a>
              ${data.tournamentId ? `<a href="tournament-results.html?id=${data.tournamentId}" class="btn btn-small" style="background: #6c757d; margin-left: 10px;">Voir le d√©tail du tournoi</a>` : ''}
            </p>
          `;

          if (data.errors && data.errors.length > 0) {
            resultsDiv.innerHTML += `
              <div class="error" style="margin-top: 20px;">
                <strong>Erreurs rencontr√©es :</strong>
                <ul style="margin-top: 10px;">
                  ${data.errors.slice(0, 10).map(err => `<li>${err.licence || err.record}: ${err.error}</li>`).join('')}
                </ul>
              </div>
            `;
          }

          resultsCard.style.display = 'block';

          // Reset form
          fileInput.value = '';
          fileName.style.display = 'none';
          document.getElementById('importForm').reset();

          // Ask if user wants to send results email
          // Only show immediately if no bonuses are configured ‚Äî
          // when bonuses are active, the admin should verify the full
          // ranking (match points + bonuses) before sending to players
          if (data.tournamentId && data.imported > 0) {
            if (data.hasBonuses) {
              // Show info message instead of popup
              showBonusInfoMessage(data.tournamentId, categoryId);
            } else {
              setTimeout(() => {
                showSendResultsPopup(data.tournamentId, categoryId);
              }, 500);
            }
          }
        } else {
          errorDiv.textContent = data.error || 'Erreur lors de l\'import';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        errorDiv.textContent = 'Erreur de connexion au serveur';
        errorDiv.style.display = 'block';
      } finally {
        importBtn.disabled = false;
        importBtn.textContent = 'Enregistrer la competition';
      }
    }

    // Proceed with validation (after overwrite confirmation or if no existing tournament)
    async function proceedWithValidation() {
      const errorDiv = document.getElementById('errorMessage');
      const importBtn = document.getElementById('importBtn');

      importBtn.textContent = 'Validation en cours...';

      try {
        // Validate and check for unknown players
        const validateResponse = await fetch(`${API_URL}/tournaments/validate`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: currentFormData
        });

        const validateData = await validateResponse.json();

        if (!validateResponse.ok) {
          throw new Error(validateData.error || 'Erreur lors de la validation');
        }

        if (validateData.status === 'validation_required' && validateData.unknownPlayers.length > 0) {
          // Show modal for unknown players
          importBtn.textContent = 'En attente de cr√©ation des joueurs...';
          showUnknownPlayersModal(validateData.unknownPlayers);
        } else {
          // All players exist, proceed with import
          importBtn.textContent = 'Import en cours...';
          await performImport(currentFormData);
        }

      } catch (error) {
        errorDiv.textContent = error.message || 'Erreur de connexion au serveur';
        errorDiv.style.display = 'block';
        importBtn.disabled = false;
        importBtn.textContent = 'Enregistrer la competition';
      }
    }

    // Form submission - branch based on qualification mode
    document.getElementById('importForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Guard against double-submit
      if (isSubmitting) return;

      const errorDiv = document.getElementById('errorMessage');
      const successDiv = document.getElementById('successMessage');
      const importBtn = document.getElementById('importBtn');

      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      const categoryId = document.getElementById('categorySelect').value;
      const tournamentNumber = document.getElementById('tournamentNumber').value;
      const tournamentDate = document.getElementById('tournamentDate').value;
      const season = document.getElementById('season').value;

      if (!categoryId || !tournamentNumber || !tournamentDate || !season) {
        errorDiv.textContent = 'Veuillez remplir tous les champs';
        errorDiv.style.display = 'block';
        return;
      }

      isSubmitting = true;
      try {
        await handleStandardSubmit(categoryId, tournamentNumber, tournamentDate, season);
      } finally {
        isSubmitting = false;
      }
    });

    // Handle standard mode submit (single file)
    async function handleStandardSubmit(categoryId, tournamentNumber, tournamentDate, season) {
      const errorDiv = document.getElementById('errorMessage');
      const importBtn = document.getElementById('importBtn');

      if (!fileInput.files[0]) {
        errorDiv.textContent = 'Veuillez s√©lectionner un fichier CSV';
        errorDiv.style.display = 'block';
        return;
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('categoryId', categoryId);
      formData.append('tournamentNumber', tournamentNumber);
      formData.append('tournamentDate', tournamentDate);
      formData.append('season', season);

      currentFormData = formData;

      importBtn.disabled = true;
      importBtn.textContent = 'V√©rification...';

      try {
        const existsResult = await checkTournamentExists(categoryId, tournamentNumber, season);

        if (existsResult.exists) {
          pendingOverwriteAction = () => proceedWithValidation();
          showExistingTournamentModal(existsResult.tournament);
        } else {
          await proceedWithValidation();
        }
      } catch (error) {
        errorDiv.textContent = error.message || 'Erreur de connexion au serveur';
        errorDiv.style.display = 'block';
        importBtn.disabled = false;
        importBtn.textContent = 'Enregistrer la competition';
      }
    }

    // ========== END OF STANDARD IMPORT ==========

    // ========== IMPORT MATCHES E2i TAB ==========

    // Tab switching
    function switchImportTab(tab) {
      document.getElementById('tabStandard').style.display = tab === 'standard' ? 'block' : 'none';
      document.getElementById('tabMatches').style.display = tab === 'matches' ? 'block' : 'none';
      document.querySelectorAll('.import-tab').forEach(t => {
        const isActive = t.dataset.tab === tab;
        t.style.color = isActive ? 'var(--color-primary, #1F4788)' : '#999';
        t.style.fontWeight = isActive ? '600' : '500';
        t.style.borderBottomColor = isActive ? 'var(--color-primary, #1F4788)' : 'transparent';
      });
      // Reset state
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
    }
    // Expose globally
    window.switchImportTab = switchImportTab;

    // Match tab selectors ‚Äî mirror the standard tab logic
    document.getElementById('matchModeSelect').addEventListener('change', (e) => {
      const selectedMode = e.target.value;
      const levelSelect = document.getElementById('matchLevelSelect');
      const categorySelect = document.getElementById('matchCategorySelect');
      levelSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
      categorySelect.value = '';
      if (selectedMode) {
        const levels = categories.filter(c => c.game_type === selectedMode).map(c => c.level).filter((v, i, a) => a.indexOf(v) === i).sort();
        levels.forEach(level => { levelSelect.innerHTML += `<option value="${level}">${level}</option>`; });
      }
    });

    document.getElementById('matchLevelSelect').addEventListener('change', (e) => {
      const selectedMode = document.getElementById('matchModeSelect').value;
      const selectedLevel = e.target.value;
      const categorySelect = document.getElementById('matchCategorySelect');
      if (selectedMode && selectedLevel) {
        const match = categories.find(c => c.game_type === selectedMode && c.level === selectedLevel);
        if (match) categorySelect.value = match.id;
      } else {
        categorySelect.value = '';
      }
    });

    document.getElementById('matchTournamentDate').addEventListener('change', (e) => {
      if (e.target.value) {
        document.getElementById('matchSeason').value = calculateSeason(e.target.value);
      }
    });

    // Phase-based multi-file upload handling
    const PHASE_KEYS = ['POULE', 'DEMI-FINALE', 'FINALE', 'CLASSEMENT'];
    let matchFilesByPhase = { 'POULE': [], 'DEMI-FINALE': [], 'FINALE': [], 'CLASSEMENT': [] };

    // Set up drag/drop/click listeners for each phase zone
    PHASE_KEYS.forEach(phase => {
      const droparea = document.getElementById('zone-' + phase);
      const fileInput = droparea.querySelector('input[type="file"]');

      droparea.addEventListener('click', (e) => { if (e.target !== fileInput) fileInput.click(); });
      droparea.addEventListener('dragover', (e) => { e.preventDefault(); droparea.classList.add('dragover'); });
      droparea.addEventListener('dragleave', () => { droparea.classList.remove('dragover'); });
      droparea.addEventListener('drop', (e) => {
        e.preventDefault();
        droparea.classList.remove('dragover');
        addMatchFilesToPhase(phase, e.dataTransfer.files);
      });
      fileInput.addEventListener('change', () => {
        addMatchFilesToPhase(phase, fileInput.files);
        fileInput.value = '';
      });
    });

    function addMatchFilesToPhase(phase, fileList) {
      const bucket = matchFilesByPhase[phase];
      for (const f of fileList) {
        if (!bucket.some(mf => mf.name === f.name && mf.size === f.size)) {
          bucket.push(f);
        }
      }
      renderPhaseFileList(phase);
    }

    function removeMatchFile(phase, index) {
      matchFilesByPhase[phase].splice(index, 1);
      renderPhaseFileList(phase);
      // Hide preview if no files in any zone
      if (getAllMatchFiles().length === 0) {
        document.getElementById('matchPreviewCard').style.display = 'none';
        document.getElementById('importMatchesBtn').style.display = 'none';
      }
    }
    window.removeMatchFile = removeMatchFile;

    function renderPhaseFileList(phase) {
      const container = document.getElementById('files-' + phase);
      const files = matchFilesByPhase[phase];
      if (files.length === 0) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = files.map((f, i) => `
        <div class="phase-file-item">
          <span>üìÑ ${f.name} <span style="color: #999;">(${(f.size / 1024).toFixed(1)} Ko)</span></span>
          <button onclick="removeMatchFile('${phase}', ${i})">‚úï</button>
        </div>
      `).join('');
    }

    function getAllMatchFiles() {
      const all = [];
      PHASE_KEYS.forEach(phase => {
        matchFilesByPhase[phase].forEach(f => all.push(f));
      });
      return all;
    }

    // Preview matches
    let lastPreviewData = null;

    async function previewMatches() {
      const errorDiv = document.getElementById('errorMessage');
      const previewBtn = document.getElementById('previewMatchesBtn');
      errorDiv.style.display = 'none';

      const categoryId = document.getElementById('matchCategorySelect').value;
      if (!categoryId) {
        errorDiv.textContent = 'Veuillez s√©lectionner un mode de jeu et un classement FFB';
        errorDiv.style.display = 'block';
        return;
      }
      const allFiles = getAllMatchFiles();
      if (allFiles.length === 0) {
        errorDiv.textContent = 'Veuillez s√©lectionner au moins un fichier CSV';
        errorDiv.style.display = 'block';
        return;
      }

      previewBtn.disabled = true;
      previewBtn.textContent = 'Analyse en cours...';

      try {
        const formData = new FormData();
        allFiles.forEach(f => formData.append('files', f));
        formData.append('categoryId', categoryId);

        const response = await fetch(`${API_URL}/tournaments/import-matches/preview`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Erreur lors de l\'analyse');

        lastPreviewData = data;
        renderMatchPreview(data);

        // Show import button
        document.getElementById('importMatchesBtn').style.display = 'inline-block';

      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      } finally {
        previewBtn.disabled = false;
        previewBtn.textContent = 'Aper√ßu des r√©sultats';
      }
    }
    window.previewMatches = previewMatches;

    function renderMatchPreview(data) {
      const card = document.getElementById('matchPreviewCard');
      const info = document.getElementById('matchPreviewInfo');
      const thead = document.getElementById('matchPreviewHead');
      const tbody = document.getElementById('matchPreviewBody');

      info.textContent = `${data.matchCount} matchs analys√©s, ${data.playerCount} joueurs, ${data.poules.length} poule(s) : ${data.poules.join(', ')}`;

      // Build header
      const hasPosPoints = data.preview.some(p => p.position_points > 0);
      const hasBonus = data.preview.some(p => p.bonus_moyenne > 0);

      let headerCols = '<th>CLT</th><th>Licence</th><th>Nom</th><th>Pr√©nom</th><th>Club</th><th>Clt poule</th>';
      if (hasPosPoints) headerCols += '<th>Pts clt</th>';
      if (hasBonus) headerCols += '<th>Bonus</th>';
      if (hasPosPoints || hasBonus) headerCols += '<th>Total</th>';
      headerCols += '<th>PM</th><th>Pts</th><th>R</th><th>MS</th><th>MGP</th><th>MPART</th><th>Pts Match</th>';
      thead.innerHTML = `<tr>${headerCols}</tr>`;

      // Build rows
      tbody.innerHTML = data.preview.map(p => {
        let row = `<td style="font-weight: bold;">${p.final_position}</td>`;
        row += `<td>${p.licence}</td>`;
        row += `<td>${p.last_name}</td>`;
        row += `<td>${p.first_name}</td>`;
        row += `<td>${p.club || (p.unknown ? '<span style="color: #dc3545;">Inconnu</span>' : '')}</td>`;
        row += `<td>${p.poule_rank || '-'}</td>`;
        if (hasPosPoints) row += `<td>${p.position_points}</td>`;
        if (hasBonus) row += `<td>${p.bonus_moyenne}</td>`;
        if (hasPosPoints || hasBonus) row += `<td style="font-weight: bold;">${p.total_points_clt}</td>`;
        row += `<td>${p.parties_menees}</td>`;
        row += `<td>${p.points}</td>`;
        row += `<td>${p.reprises}</td>`;
        row += `<td>${p.max_serie}</td>`;
        row += `<td>${p.mgp.toFixed(3)}</td>`;
        row += `<td>${p.mpart.toFixed(3)}</td>`;
        row += `<td>${p.match_points}</td>`;
        return `<tr>${row}</tr>`;
      }).join('');

      card.style.display = 'block';
    }

    // Import matches (after preview)
    async function importMatches() {
      const errorDiv = document.getElementById('errorMessage');
      const successDiv = document.getElementById('successMessage');
      const importBtn = document.getElementById('importMatchesBtn');
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      const categoryId = document.getElementById('matchCategorySelect').value;
      const tournamentNumber = document.getElementById('matchTournamentNumber').value;
      const tournamentDate = document.getElementById('matchTournamentDate').value;
      const season = document.getElementById('matchSeason').value;

      if (!categoryId || !tournamentNumber || !tournamentDate || !season) {
        errorDiv.textContent = 'Veuillez remplir tous les champs (mode, classement, tournoi, date)';
        errorDiv.style.display = 'block';
        return;
      }

      const allFiles = getAllMatchFiles();
      if (allFiles.length === 0) {
        errorDiv.textContent = 'Veuillez s√©lectionner au moins un fichier CSV';
        errorDiv.style.display = 'block';
        return;
      }

      // Check if tournament exists
      const existsResult = await checkTournamentExists(categoryId, tournamentNumber, season);
      if (existsResult.exists) {
        if (!confirm(`Un tournoi existe d√©j√† pour cette cat√©gorie/num√©ro/saison (${existsResult.tournament.playerCount} joueurs). Voulez-vous le remplacer ?`)) {
          return;
        }
      }

      importBtn.disabled = true;
      importBtn.textContent = 'Import en cours...';

      try {
        const formData = new FormData();
        allFiles.forEach(f => formData.append('files', f));
        formData.append('categoryId', categoryId);
        formData.append('tournamentNumber', tournamentNumber);
        formData.append('tournamentDate', tournamentDate);
        formData.append('season', season);

        const response = await fetch(`${API_URL}/tournaments/import-matches`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Erreur lors de l\'import');

        successDiv.textContent = `Import r√©ussi ! ${data.matchCount} matchs import√©s, ${data.imported} joueurs class√©s. Les classements ont √©t√© recalcul√©s.`;
        successDiv.style.display = 'block';

        // Show results card
        const resultsCard = document.getElementById('resultsCard');
        const resultsDiv = document.getElementById('importResults');
        resultsDiv.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <h4>Matchs import√©s</h4>
              <div class="stat-value">${data.matchCount}</div>
            </div>
            <div class="stat-card">
              <h4>Joueurs class√©s</h4>
              <div class="stat-value">${data.imported}</div>
            </div>
            <div class="stat-card">
              <h4>Poules</h4>
              <div class="stat-value">${data.poules ? data.poules.length : 0}</div>
            </div>
          </div>
          <p style="margin-top: 20px;">
            <a href="rankings.html?categoryId=${categoryId}" class="btn btn-small">Voir les classements mis √† jour</a>
            ${data.tournamentId ? `<a href="tournament-results.html?id=${data.tournamentId}" class="btn btn-small" style="background: #6c757d; margin-left: 10px;">Voir le d√©tail du tournoi</a>` : ''}
          </p>
        `;

        if (data.hasBonuses) {
          showBonusInfoMessage(data.tournamentId, categoryId);
        }

        resultsCard.style.display = 'block';

        // Reset match form
        PHASE_KEYS.forEach(phase => {
          matchFilesByPhase[phase] = [];
          renderPhaseFileList(phase);
        });
        document.getElementById('matchPreviewCard').style.display = 'none';
        document.getElementById('importMatchesBtn').style.display = 'none';

      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      } finally {
        importBtn.disabled = false;
        importBtn.textContent = 'Importer les matchs';
      }
    }
    window.importMatches = importMatches;

    // ========== END OF MATCH IMPORT ==========

    // Load tournament rounds dynamically
    async function loadTournamentRounds() {
      try {
        const response = await fetch(`${API_URL}/reference-data/tournament-rounds`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const rounds = await response.json();
          const options = '<option value="">-- S√©lectionner --</option>' +
            rounds.map(r => `<option value="${r.tournament_number}">${r.display_name}</option>`).join('');
          document.getElementById('tournamentNumber').innerHTML = options;
          document.getElementById('matchTournamentNumber').innerHTML = options;
        }
      } catch (error) {
        console.error('Error loading tournament rounds:', error);
      }
    }

    // Load qualification mode and show/hide bracket zones accordingly
    async function loadQualificationMode() {
      try {
        const response = await fetch(`${API_URL}/settings/app/qualification_mode`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          const isJournees = data.value === 'journees';
          document.querySelectorAll('.phase-zone-bracket').forEach(el => {
            el.style.display = isJournees ? '' : 'none';
          });
          // In standard mode, make Poules zone full-width
          const grid = document.getElementById('phaseUploadGrid');
          if (!isJournees) {
            grid.style.gridTemplateColumns = '1fr';
          } else {
            grid.style.gridTemplateColumns = '1fr 1fr';
          }
        }
      } catch (error) {
        console.error('Error loading qualification mode:', error);
      }
    }

    // Initialize
    loadCategories();
    loadClubs();
    loadTournamentRounds();
    loadQualificationMode();

    // Set today's date as default value (both tabs)
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('tournamentDate').value = today;
    document.getElementById('matchTournamentDate').value = today;

    // Auto-calculate season for today's date (both tabs)
    const season = calculateSeason(today);
    document.getElementById('season').value = season;
    document.getElementById('matchSeason').value = season;

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      window.location.href = 'login.html';
    });

    // Show info message when bonuses are active (no immediate send)
    function showBonusInfoMessage(tournamentId, categoryId) {
      const resultsDiv = document.getElementById('importResults');
      const infoHtml = `
        <div style="margin-top: 20px; padding: 16px 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; color: #856404;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span style="font-size: 20px;">&#9432;</span>
            <strong>Envoi des r√©sultats</strong>
          </div>
          <p style="margin: 0 0 12px 0;">
            Les classements incluent des bonus (moyenne, bar√®me‚Ä¶). V√©rifiez le classement mis √† jour avant d'envoyer les r√©sultats aux joueurs.
          </p>
          <p style="margin: 0;">
            Vous pourrez envoyer les r√©sultats depuis la page
            <a href="tournaments-list.html" style="color: #856404; font-weight: bold;">Comp√©titions Jou√©es</a>
            apr√®s v√©rification.
          </p>
        </div>
      `;
      resultsDiv.insertAdjacentHTML('beforeend', infoHtml);
    }

    // Show send results popup
    function showSendResultsPopup(tournamentId, categoryId) {
      const modal = document.getElementById('sendResultsModal');
      modal.style.display = 'flex';

      // Handle Yes button - redirect to emailing page
      document.getElementById('sendResultsYesBtn').onclick = () => {
        modal.style.display = 'none';
        // Redirect to emailing page with tournament pre-selected
        window.location.href = `emailing.html?tab=results&tournamentId=${tournamentId}`;
      };

      // Handle No button - just close
      document.getElementById('sendResultsNoBtn').onclick = () => {
        modal.style.display = 'none';
      };
    }
  </script>
  <script src="js/help-button.js?v=203"></script>
  <script src="js/upcoming-tournaments.js?v=235"></script>
</body>
</html>
