<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord Ligue</title>
  <link rel="icon" type="image/png" href="images/FFB.png">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/branding.js"></script>
  <style>
    .compact-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 10px; }
    .compact-stat {
      padding: 12px; border-radius: 12px; text-align: center; color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 10px 28px rgba(0,0,0,0.12);
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .compact-stat:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.18), 0 16px 36px rgba(0,0,0,0.14);
    }
    .compact-stat h5 { margin: 0 0 4px 0; font-size: 11px; opacity: 0.9; text-transform: uppercase; }
    .compact-stat .val { font-size: 28px; font-weight: bold; line-height: 1; }
    .section-title { font-size: 13px; color: #666; margin: 16px 0 8px 0; font-weight: bold; text-transform: uppercase; }
    .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table th { background: #f5f5f5; padding: 8px 10px; text-align: left; font-size: 11px; text-transform: uppercase; color: #666; }
    .data-table td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; }
    .data-table tr:hover { background: #fafafa; }
    .badge { padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .badge-active { background: #d4edda; color: #155724; }
    .badge-inactive { background: #f8d7da; color: #721c24; }
    .mode-tabs { display: flex; gap: 0; background: white; border-radius: 8px; overflow: hidden; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    .mode-tab {
      flex: 1; text-align: center; padding: 10px 8px; font-size: 13px; font-weight: 600;
      color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;
      background: none; border: none; border-bottom: 3px solid transparent;
    }
    .mode-tab:hover { background: #f8f9fa; color: #333; }
    .mode-tab.active { color: var(--color-primary, #1F4788); border-bottom-color: var(--color-primary, #1F4788); background: #f0f4ff; }
    .rank-badge {
      display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: bold;
    }
    .rank-N { background: #fff3cd; color: #856404; }
    .rank-R { background: #d1ecf1; color: #0c5460; }
    .rank-D { background: #e2e3e5; color: #383d41; }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <div>
        <h2 style="margin-bottom: 0;"><img id="ligueLogo" src="images/FFB.png" alt="" style="height: 48px; width: 48px; vertical-align: middle; margin-right: 8px; border-radius: 6px;" onerror="this.src='images/FrenchBillard-Icon-small.png';"><span id="ligueTitle">Tableau de bord Ligue</span></h2>
      </div>
      <div class="nav-links">
        <a href="#" id="logoutBtn" class="nav-logout">Deconnexion</a>
      </div>
    </div>

    <div id="accessDenied" style="display: none; text-align: center; padding: 40px; color: #666;">
      <h3>Acces refuse</h3>
      <p>Cette page est reservee aux administrateurs de ligue.</p>
      <a href="login.html" class="btn">Retour</a>
    </div>

    <div id="dashboardContent" style="display: none;">
      <!-- Stats Overview -->
      <div class="section-title" id="overviewTitle">Vue d'ensemble</div>
      <div class="compact-stats">
        <div class="compact-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h5>CDBs</h5>
          <div class="val" id="kpiCdbs">-</div>
        </div>
        <div class="compact-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h5>Joueurs</h5>
          <div class="val" id="kpiPlayers">-</div>
        </div>
        <div class="compact-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h5>Clubs</h5>
          <div class="val" id="kpiClubs">-</div>
        </div>
        <div class="compact-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h5>Tournois</h5>
          <div class="val" id="kpiTournaments">-</div>
        </div>
      </div>

      <!-- CDB List -->
      <div class="section-title">CDBs de la ligue <span id="cdbCount" style="font-weight: normal; color: #999;"></span></div>
      <div class="card" style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>CDB</th>
              <th>Code FFB</th>
              <th>Joueurs</th>
              <th>Clubs</th>
              <th>Tournois</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody id="cdbsBody">
            <tr><td colspan="7" style="text-align: center; color: #999;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Top Players -->
      <div class="section-title">Meilleurs joueurs</div>
      <div id="modeTabsContainer" class="mode-tabs">
        <div style="text-align: center; padding: 10px; color: #999; font-size: 13px;">Chargement...</div>
      </div>
      <div class="card" style="overflow-x: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Joueur</th>
              <th>CDB</th>
              <th>Classement</th>
              <th>Licence</th>
            </tr>
          </thead>
          <tbody id="playersBody">
            <tr><td colspan="5" style="text-align: center; color: #999;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script>
    const API_URL = '/api';

    if (!requireAuth()) {
      throw new Error('Not authenticated');
    }
    const token = localStorage.getItem('token');

    // Check ligue admin or super admin access
    const userRole = localStorage.getItem('userRole');
    const isSuperAdmin = localStorage.getItem('isSuperAdmin') === 'true';
    if (userRole !== 'ligue_admin' && !isSuperAdmin) {
      document.getElementById('dashboardContent').style.display = 'none';
      document.getElementById('accessDenied').style.display = 'block';
    } else {
      document.getElementById('dashboardContent').style.display = 'block';
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      logout();
    });

    let currentMode = 'LIBRE';

    function formatDateShort(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function getRankTier(ranking) {
      if (!ranking) return '';
      if (ranking.startsWith('N')) return 'N';
      if (ranking.startsWith('R')) return 'R';
      return 'D';
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        const response = await authFetch(`${API_URL}/ligue-admin/dashboard`);
        if (response.status === 403) {
          document.getElementById('dashboardContent').style.display = 'none';
          document.getElementById('accessDenied').style.display = 'block';
          return;
        }
        const data = await response.json();

        // Title + logo
        if (data.ligue) {
          document.getElementById('ligueTitle').textContent = `Ligue ${data.ligue.nom}`;
          document.getElementById('overviewTitle').textContent = `Vue d'ensemble â€” Ligue ${data.ligue.nom}`;
          // Try to load ligue logo
          const logoImg = document.getElementById('ligueLogo');
          const logoUrl = `${API_URL}/ligue-admin/ligue-logo`;
          fetch(logoUrl, { headers: { 'Authorization': `Bearer ${token}` } })
            .then(r => { if (r.ok) logoImg.src = logoUrl + '?t=' + Date.now(); });
        }

        // Stats
        document.getElementById('kpiCdbs').textContent = data.stats.cdbs.toLocaleString('fr-FR');
        document.getElementById('kpiPlayers').textContent = data.stats.players.toLocaleString('fr-FR');
        document.getElementById('kpiClubs').textContent = data.stats.clubs.toLocaleString('fr-FR');
        document.getElementById('kpiTournaments').textContent = data.stats.tournaments.toLocaleString('fr-FR');

        // CDB table
        const cdbs = data.cdbs;
        document.getElementById('cdbCount').textContent = `(${cdbs.length})`;
        const tbody = document.getElementById('cdbsBody');

        if (!cdbs.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;">Aucun CDB dans cette ligue</td></tr>';
        } else {
          tbody.innerHTML = cdbs.map((cdb, idx) => {
            const statusBadge = cdb.is_active
              ? '<span class="badge badge-active">Actif</span>'
              : '<span class="badge badge-inactive">Inactif</span>';
            return `<tr>
              <td><strong>${idx + 1}</strong></td>
              <td><strong>${cdb.short_name}</strong><br><span style="font-size:11px;color:#888;">${cdb.name}</span></td>
              <td>${cdb.ffb_cdb_code || '-'}</td>
              <td>${parseInt(cdb.player_count).toLocaleString('fr-FR')}</td>
              <td>${parseInt(cdb.club_count)}</td>
              <td>${parseInt(cdb.tournament_count)}</td>
              <td>${statusBadge}</td>
            </tr>`;
          }).join('');
        }
      } catch (error) {
        console.error('Error loading ligue dashboard:', error);
      }
    }

    // Load game modes for tabs
    async function loadGameModes() {
      try {
        const response = await authFetch(`${API_URL}/ligue-admin/game-modes`);
        const modes = await response.json();

        if (!modes.length) return;

        const container = document.getElementById('modeTabsContainer');
        container.innerHTML = modes.map(mode => {
          const isActive = mode.code === currentMode ? 'active' : '';
          return `<button class="mode-tab ${isActive}" data-mode="${mode.code}">${mode.display_name}</button>`;
        }).join('');

        // Attach click handlers
        container.querySelectorAll('.mode-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            currentMode = tab.dataset.mode;
            container.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            loadTopPlayers();
          });
        });
      } catch (error) {
        console.error('Error loading game modes:', error);
      }
    }

    // Load top players for current mode
    async function loadTopPlayers() {
      const tbody = document.getElementById('playersBody');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">Chargement...</td></tr>';

      try {
        const response = await authFetch(`${API_URL}/ligue-admin/top-players?mode=${currentMode}&limit=20`);
        const players = await response.json();

        if (!players.length) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">Aucun joueur classe dans ce mode</td></tr>';
          return;
        }

        tbody.innerHTML = players.map((p, idx) => {
          const tier = getRankTier(p.ranking);
          return `<tr>
            <td><strong>${idx + 1}</strong></td>
            <td>${p.last_name} ${p.first_name}</td>
            <td>${p.cdb_name}</td>
            <td><span class="rank-badge rank-${tier}">${p.ranking}</span></td>
            <td style="color: #999; font-size: 12px;">${p.licence}</td>
          </tr>`;
        }).join('');
      } catch (error) {
        console.error('Error loading top players:', error);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#c00;">Erreur de chargement</td></tr>';
      }
    }

    // Initialize
    loadDashboard();
    loadGameModes().then(() => loadTopPlayers());
  </script>
</body>
</html>
