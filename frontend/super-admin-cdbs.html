<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plateforme Gestion des Tournois CDB - CDBs</title>
  <link rel="icon" type="image/png" href="images/FFB.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .sa-nav { display: flex; gap: 0; background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
    .sa-nav a {
      flex: 1; text-align: center; padding: 12px 8px; text-decoration: none; font-size: 13px; font-weight: 600;
      color: #666; border-bottom: 3px solid transparent; transition: all 0.2s;
    }
    .sa-nav a:hover { background: #f8f9fa; color: #333; }
    .sa-nav a.active { color: var(--color-primary, #1F4788); border-bottom-color: var(--color-primary, #1F4788); background: #f0f4ff; }
    .sa-nav a .nav-icon { display: block; font-size: 18px; margin-bottom: 2px; }

    .section-title { font-size: 13px; color: #666; margin: 16px 0 8px 0; font-weight: bold; text-transform: uppercase; }
    .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card h3 { margin: 0 0 12px 0; font-size: 15px; color: #333; }

    /* CDB table */
    .orgs-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .orgs-table th { background: #f5f5f5; padding: 8px 10px; text-align: left; font-size: 11px; text-transform: uppercase; color: #666; }
    .orgs-table td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; }
    .orgs-table tr:hover { background: #fafafa; }
    .badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
    .badge-active { background: #d4edda; color: #155724; }
    .badge-inactive { background: #f8d7da; color: #721c24; }
    .badge-warning { background: #fff3cd; color: #856404; }

    /* Create form */
    .create-form { display: none; }
    .create-form.visible { display: block; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
    .form-grid .form-group { margin-bottom: 0; }
    .form-grid label { display: block; font-size: 12px; font-weight: 600; color: #555; margin-bottom: 4px; }
    .form-grid input { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; box-sizing: border-box; }
    .form-grid input:focus { border-color: var(--color-primary, #1F4788); outline: none; box-shadow: 0 0 0 2px rgba(31,71,136,0.1); }
    .form-actions { margin-top: 12px; display: flex; gap: 8px; }

    /* Seeding section */
    .seed-section { display: none; }
    .seed-section.visible { display: block; }
    .seed-preview { background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    .seed-preview .count { font-size: 24px; font-weight: bold; color: #2e7d32; }
    .seed-preview table { width: 100%; margin-top: 8px; font-size: 12px; border-collapse: collapse; }
    .seed-preview table th { text-align: left; padding: 4px 6px; color: #666; }
    .seed-preview table td { padding: 4px 6px; border-top: 1px solid #c8e6c9; }

    /* Action buttons */
    .btn-sm { padding: 4px 12px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; }
    .btn-primary { background: var(--color-primary, #1F4788); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-outline { background: white; color: #333; border: 1px solid #ddd; }
    .btn-outline:hover { background: #f5f5f5; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-warning:hover { background: #e0a800; }
    .btn-lg { padding: 10px 24px; font-size: 14px; border-radius: 6px; }

    /* Toast */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; font-size: 14px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; }
    .toast.success { background: #28a745; }
    .toast.error { background: #dc3545; }
    .toast.visible { display: block; }

    /* Spinner */
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <div>
        <h2 style="margin-bottom: 0;"><img id="app-header-icon" src="images/FFB.png" alt="" style="height: 48px; width: 48px; vertical-align: middle; margin-right: 8px; border-radius: 6px;" onerror="this.src='images/FrenchBillard-Icon-small.png';"><span id="app-org-name" data-page-title="Super Admin">Plateforme Gestion des Tournois CDB</span></h2>
      </div>
      <div class="nav-links">
        <a href="#" id="logoutBtn" class="nav-logout">Déconnexion</a>
      </div>
    </div>

    <!-- Super Admin Navigation -->
    <nav class="sa-nav">
      <a href="super-admin.html">
        <span class="nav-icon">&#x1F4CA;</span>
        Tableau de bord
      </a>
      <a href="super-admin-cdbs.html" class="active">
        <span class="nav-icon">&#x1F3E2;</span>
        CDBs
      </a>
      <a href="super-admin-ligues.html">
        <span class="nav-icon">&#x1F3DB;</span>
        Ligues
      </a>
      <a href="super-admin-ffb.html">
        <span class="nav-icon">&#x1F4C1;</span>
        Données FFB
      </a>
      <a href="super-admin-ffb-browser.html">
        <span class="nav-icon">&#x1F50D;</span>
        FFB Fichiers
      </a>
      <a href="super-admin-users.html">
        <span class="nav-icon">&#x1F465;</span>
        Utilisateurs
      </a>
      <a href="super-admin-settings.html">
        <span class="nav-icon">&#x2699;</span>
        Paramètres
      </a>
    </nav>

    <!-- CDB List -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h3 style="margin: 0;">Organisations (CDBs)</h3>
        <button class="btn-sm btn-primary btn-lg" onclick="toggleCreateForm()">+ Créer un CDB</button>
      </div>
      <div style="overflow-x: auto;">
        <table class="orgs-table" id="orgsTable">
          <thead>
            <tr>
              <th>N°</th>
              <th>Nom</th>
              <th>Code FFB</th>
              <th>Clubs</th>
              <th>Joueurs</th>
              <th>Utilisateurs</th>
              <th>Inscription</th>
              <th>Bienvenue</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="orgsTbody">
            <tr><td colspan="10" style="text-align: center; color: #999;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Create CDB Form (hidden by default) -->
    <div class="card create-form" id="createForm">
      <h3>Créer un nouveau CDB</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>Ligue</label>
          <select id="ffbLigueSelect" onchange="onLigueSelected()" style="width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; box-sizing: border-box;">
            <option value="">-- Sélectionner une Ligue --</option>
          </select>
        </div>
        <div class="form-group">
          <label>CDB (depuis fichier FFB)</label>
          <select id="ffbCdbSelect" onchange="onFfbCdbSelected()" style="width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; box-sizing: border-box;">
            <option value="">-- Sélectionner d'abord une Ligue --</option>
          </select>
        </div>
        <div class="form-group">
          <label>CDB secondaire (optionnel)</label>
          <select id="ffbCdbSelect2" onchange="onFfbCdb2Selected()" style="width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; box-sizing: border-box;">
            <option value="">-- Aucun --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Nom complet</label>
          <input type="text" id="orgName" placeholder="Auto-rempli depuis FFB">
        </div>
        <div class="form-group">
          <label>Nom court</label>
          <input type="text" id="orgShortName" placeholder="ex: CDB94" oninput="autoSlug()">
        </div>
        <div class="form-group">
          <label>Slug (URL)</label>
          <input type="text" id="orgSlug" placeholder="ex: cdb94">
        </div>
        <div class="form-group">
          <label>Code CDB FFB</label>
          <input type="text" id="orgFfbCode" placeholder="Auto-rempli" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label>Ligue FFB</label>
          <input type="text" id="orgLigue" placeholder="Auto-rempli" readonly style="background: #f5f5f5;">
        </div>
        <!-- Admin section -->
        <div class="form-group" style="grid-column: 1 / -1; margin-top: 8px; border-top: 1px solid #eee; padding-top: 12px;">
          <label style="font-size: 13px; font-weight: 700; color: #333;">Administrateur du CDB</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="text" id="adminSearch" placeholder="Rechercher un licencié (nom, prénom ou licence)..." oninput="searchAdmin()" style="flex: 1;">
            <span id="adminSearchSpinner" style="display: none; font-size: 12px; color: #888;">Recherche...</span>
          </div>
          <div id="adminSearchResults" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; margin-top: 4px; background: white;"></div>
        </div>
        <div id="adminSelectedInfo" style="grid-column: 1 / -1; display: none; background: #e8f5e9; padding: 12px; border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <strong id="adminSelectedName" style="font-size: 14px;"></strong>
              <span id="adminSelectedLicence" style="font-size: 12px; color: #666; margin-left: 8px;"></span>
              <div style="margin-top: 6px; font-size: 13px;">
                <span style="color: #555;">Email:</span> <span id="adminSelectedEmail" style="color: #333;">-</span>
              </div>
              <div style="margin-top: 2px; font-size: 13px;">
                <span style="color: #555;">Tél. portable:</span> <span id="adminSelectedTelPort" style="color: #333;">-</span>
                <span style="color: #555; margin-left: 12px;">Tél. fixe:</span> <span id="adminSelectedTelFixe" style="color: #333;">-</span>
              </div>
            </div>
            <button class="btn-sm btn-outline" onclick="clearAdminSelection()" style="font-size: 11px;">Changer</button>
          </div>
        </div>
        <div class="form-group">
          <label>Identifiant admin</label>
          <input type="text" id="adminUsername" placeholder="ex: admin94">
        </div>
        <div class="form-group">
          <label>Mot de passe admin (envoi par SMS)</label>
          <input type="text" id="adminPassword" placeholder="Mot de passe à communiquer par SMS">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-sm btn-primary btn-lg" onclick="createOrganization()" id="btnCreate">Créer</button>
        <button class="btn-sm btn-outline btn-lg" onclick="toggleCreateForm()">Annuler</button>
      </div>
    </div>

    <!-- Post-creation / Manage: CDB summary with login URL + welcome email -->
    <div class="card seed-section" id="orgSummarySection">
      <h3>Gestion — <span id="summaryOrgName"></span></h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
        <div style="background: #e3f2fd; padding: 12px; border-radius: 8px;">
          <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600;">Clubs importés</div>
          <div style="font-size: 22px; font-weight: bold; color: #1565c0;" id="summaryClubs">-</div>
        </div>
        <div style="background: #e8f5e9; padding: 12px; border-radius: 8px;">
          <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600;">Joueurs importés</div>
          <div style="font-size: 22px; font-weight: bold; color: #2e7d32;" id="summaryPlayers">-</div>
        </div>
        <div style="background: #fff3e0; padding: 12px; border-radius: 8px;">
          <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600;">Administrateur</div>
          <div style="font-size: 14px; font-weight: bold; color: #e65100;" id="summaryAdmin">-</div>
        </div>
      </div>
      <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
        <label style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 4px;">URL de connexion du CDB (Gestion)</label>
        <div style="display: flex; gap: 8px; align-items: center;">
          <input type="text" id="summaryLoginUrl" readonly style="flex: 1; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; background: white; font-family: monospace;" />
          <button class="btn-sm btn-outline" onclick="copyUrl('summaryLoginUrl')" title="Copier l'URL">Copier</button>
        </div>
      </div>
      <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
        <label style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 4px;">URL Espace Joueur (Player App)</label>
        <div style="display: flex; gap: 8px; align-items: center;">
          <input type="text" id="summaryPlayerAppUrl" readonly style="flex: 1; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; background: white; font-family: monospace;" />
          <button class="btn-sm btn-outline" onclick="copyUrl('summaryPlayerAppUrl')" title="Copier l'URL">Copier</button>
        </div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center;">
        <button class="btn-sm btn-primary btn-lg" onclick="sendWelcomeEmail()" id="btnSendWelcome">Envoyer l'email de bienvenue</button>
        <span id="welcomeResult" style="font-size: 13px;"></span>
      </div>
    </div>

    <!-- Sync Players with FFB (visible when an org is selected) -->
    <div class="card seed-section" id="syncSection">
      <h3>Synchroniser les joueurs avec le fichier FFB — <span id="syncOrgName"></span></h3>
      <p style="font-size: 12px; color: #888; margin: 0 0 12px 0;">Compare les joueurs existants avec les données FFB et affiche les différences avant application.</p>
      <div id="syncPreview" style="margin-bottom: 12px;"></div>
      <div style="display: flex; gap: 8px;">
        <button class="btn-sm btn-primary btn-lg" onclick="previewSync()" id="btnSyncPreview">Analyser les différences</button>
        <button class="btn-sm btn-success btn-lg" onclick="executeSync()" id="btnSyncApply" style="display: none;">Appliquer la synchronisation</button>
      </div>
      <div id="syncResult" style="margin-top: 12px;"></div>
    </div>

  </div>

  <!-- Toast notification -->
  <div class="toast" id="toast"></div>

  <script src="js/auth-utils.js"></script>
  <script>
    const API_URL = '/api';
    if (!requireAuth()) throw new Error('Not authenticated');
    const token = localStorage.getItem('token');
    if (localStorage.getItem('isSuperAdmin') !== 'true') {
      localStorage.clear();
      window.location.href = 'login.html?sa=1';
      throw new Error('Not super admin');
    }

    // Initialize branding
    if (typeof initPublicBranding === 'function') initPublicBranding();

    document.getElementById('logoutBtn').addEventListener('click', (e) => { e.preventDefault(); logout(); });

    // State
    let currentOrgId = null;

    // ==================== Toast ====================
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} visible`;
      setTimeout(() => toast.classList.remove('visible'), 4000);
    }

    // ==================== Load Organizations ====================
    async function loadOrganizations() {
      try {
        const res = await authFetch(`${API_URL}/super-admin/organizations`);
        const orgs = await res.json();
        const tbody = document.getElementById('orgsTbody');

        if (orgs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">Aucune organisation</td></tr>';
          return;
        }

        tbody.innerHTML = orgs.map((org, idx) => {
          const enrollDate = org.created_at ? new Date(org.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '-';
          const enrollNum = String(idx + 1).padStart(3, '0');
          const welcomeSent = org.welcome_email_sent_at;
          const welcomeBadge = welcomeSent
            ? `<span class="badge badge-active" style="cursor: pointer;" onclick="toggleWelcomeStatus(${org.id}, false)" title="Envoyé le ${new Date(welcomeSent).toLocaleDateString('fr-FR')} — Cliquer pour remettre en attente">Envoyé</span>`
            : `<span class="badge badge-warning" style="cursor: pointer;" onclick="toggleWelcomeStatus(${org.id}, true)" title="Cliquer pour marquer comme envoyé">En attente</span>`;
          return `
          <tr>
            <td><strong>#${enrollNum}</strong></td>
            <td><strong>${org.short_name}</strong><br><span style="font-size: 11px; color: #888;">${org.name}</span><br><code style="font-size: 10px; color: #aaa;">${org.slug}</code></td>
            <td>${org.ffb_cdb_code || '-'}</td>
            <td>${org.club_count || 0}</td>
            <td>${org.player_count || 0}</td>
            <td>${org.user_count || 0}</td>
            <td style="font-size: 12px; white-space: nowrap;">${enrollDate}</td>
            <td>${welcomeBadge}</td>
            <td><span class="badge ${org.is_active ? 'badge-active' : 'badge-inactive'}">${org.is_active ? 'Actif' : 'Inactif'}</span></td>
            <td style="white-space: nowrap;">
              <button class="btn-sm btn-primary" onclick="goToDashboard(${org.id}, '${org.slug}')" title="Voir le dashboard">Dashboard</button>
              <button class="btn-sm btn-outline" onclick="selectOrg(${org.id}, '${org.short_name}', '${org.slug}', {clubs: ${org.club_count || 0}, players: ${org.player_count || 0}, admin: '${(org.admin_username || '-').replace(/'/g, "\\'")}', welcomeSent: ${welcomeSent ? 'true' : 'false'}})" title="Gérer">Gérer</button>
              <button class="btn-sm ${org.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleActive(${org.id})" title="${org.is_active ? 'Désactiver' : 'Activer'}">${org.is_active ? 'Désact.' : 'Activer'}</button>
              ${org.id !== 1 ? `<button class="btn-sm btn-danger" onclick="deleteOrg(${org.id}, '${org.short_name.replace(/'/g, "\\'")}')" title="Supprimer" style="margin-left: 4px;">Suppr.</button>` : ''}
            </td>
          </tr>
        `}).join('');
      } catch (error) {
        console.error('Error loading orgs:', error);
        showToast('Erreur de chargement', 'error');
      }
    }

    // ==================== Toggle Welcome Email Status ====================
    async function toggleWelcomeStatus(orgId, markAsSent) {
      try {
        await authFetch(`${API_URL}/super-admin/organizations/${orgId}/welcome-status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sent: markAsSent })
        });
        showToast(markAsSent ? 'Marqué comme envoyé' : 'Remis en attente');
        loadOrganizations();
      } catch (error) {
        showToast('Erreur', 'error');
      }
    }

    // ==================== FFB CDB Picklist with Ligue Filter ====================
    let ffbCdbs = [];

    async function loadFfbCdbs() {
      try {
        const res = await authFetch(`${API_URL}/super-admin/ffb-cdbs`);
        ffbCdbs = await res.json();

        // Populate ligue selector with distinct ligues
        const ligues = [...new Map(ffbCdbs.map(c => [c.ligue_numero, c.ligue_nom || 'Ligue ' + c.ligue_numero])).entries()];
        ligues.sort((a, b) => (a[1] || '').localeCompare(b[1] || ''));
        const ligueSelect = document.getElementById('ffbLigueSelect');
        ligueSelect.innerHTML = '<option value="">-- Sélectionner une Ligue --</option>' +
          ligues.map(([num, nom]) => `<option value="${num}">${nom}</option>`).join('');

        // CDB select starts empty until a ligue is chosen
        document.getElementById('ffbCdbSelect').innerHTML = '<option value="">-- Sélectionner d\'abord une Ligue --</option>';
      } catch (error) {
        console.error('Error loading FFB CDBs:', error);
      }
    }

    function onLigueSelected() {
      const ligueNum = document.getElementById('ffbLigueSelect').value;
      const select = document.getElementById('ffbCdbSelect');
      const select2 = document.getElementById('ffbCdbSelect2');
      if (!ligueNum) {
        select.innerHTML = '<option value="">-- Sélectionner d\'abord une Ligue --</option>';
        select2.innerHTML = '<option value="">-- Aucun --</option>';
        return;
      }
      const filtered = ffbCdbs.filter(c => c.ligue_numero === ligueNum);
      const options = filtered.map(c => `<option value="${c.code}">Dept. ${c.code} (${c.licence_count} licenciés, ${c.club_count} clubs)</option>`).join('');
      select.innerHTML = '<option value="">-- Sélectionner un CDB --</option>' + options;
      select2.innerHTML = '<option value="">-- Aucun --</option>' + options;
    }

    function updateFormFromCdbSelections() {
      const code1 = document.getElementById('ffbCdbSelect').value;
      const code2 = document.getElementById('ffbCdbSelect2').value;
      const cdb1 = ffbCdbs.find(c => c.code === code1);

      // Reset admin selection when CDB changes
      clearAdminSelection();

      if (!cdb1) {
        document.getElementById('orgName').value = '';
        document.getElementById('orgFfbCode').value = '';
        document.getElementById('orgLigue').value = '';
        document.getElementById('orgShortName').value = '';
        document.getElementById('orgSlug').value = '';
        document.getElementById('adminUsername').value = '';
        return;
      }

      if (code2 && code2 !== code1) {
        // Dual CDB
        document.getElementById('orgName').value = `Comité Départemental de Billard ${code1} & ${code2}`;
        document.getElementById('orgFfbCode').value = `${code1},${code2}`;
        document.getElementById('orgShortName').value = `CDB${code1}${code2}`;
        document.getElementById('adminUsername').value = `admin${code1}${code2}`;
      } else {
        // Single CDB
        document.getElementById('orgName').value = `Comité Départemental de Billard ${code1}`;
        document.getElementById('orgFfbCode').value = code1;
        document.getElementById('orgShortName').value = `CDB${code1}`;
        document.getElementById('adminUsername').value = `admin${code1}`;
      }
      document.getElementById('orgLigue').value = cdb1.ligue_numero || '';
      autoSlug();
    }

    function onFfbCdbSelected() {
      updateFormFromCdbSelections();
    }

    function onFfbCdb2Selected() {
      const code1 = document.getElementById('ffbCdbSelect').value;
      const code2 = document.getElementById('ffbCdbSelect2').value;
      if (code2 && code2 === code1) {
        showToast('Le CDB secondaire doit être différent du premier', 'error');
        document.getElementById('ffbCdbSelect2').value = '';
        return;
      }
      updateFormFromCdbSelections();
    }

    // ==================== Admin Search ====================
    let adminSearchTimeout = null;
    let selectedAdmin = null;

    function searchAdmin() {
      clearTimeout(adminSearchTimeout);
      const q = document.getElementById('adminSearch').value.trim();
      const cdbCode = document.getElementById('orgFfbCode').value;
      const resultsDiv = document.getElementById('adminSearchResults');

      if (!cdbCode) {
        showToast('Sélectionnez d\'abord un CDB', 'error');
        return;
      }
      if (q.length < 2) {
        resultsDiv.style.display = 'none';
        return;
      }

      document.getElementById('adminSearchSpinner').style.display = 'inline';
      adminSearchTimeout = setTimeout(async () => {
        try {
          const res = await authFetch(`${API_URL}/super-admin/ffb-licences/search?cdb_code=${encodeURIComponent(cdbCode)}&q=${encodeURIComponent(q)}`);
          const players = await res.json();

          if (players.length === 0) {
            resultsDiv.innerHTML = '<div style="padding: 10px; color: #999; font-size: 13px;">Aucun résultat</div>';
          } else {
            resultsDiv.innerHTML = players.map(p => `
              <div style="padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 13px;"
                   onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='white'"
                   onclick='selectAdmin(${JSON.stringify(p).replace(/'/g, "&#39;")})'>
                <strong>${p.prenom} ${p.nom}</strong>
                <span style="color: #888; margin-left: 8px;">${p.licence}</span>
                ${p.email ? `<span style="color: #666; margin-left: 8px; font-size: 11px;">${p.email}</span>` : ''}
              </div>
            `).join('');
          }
          resultsDiv.style.display = 'block';
        } catch (error) {
          console.error('Admin search error:', error);
        } finally {
          document.getElementById('adminSearchSpinner').style.display = 'none';
        }
      }, 300);
    }

    function selectAdmin(player) {
      selectedAdmin = player;
      document.getElementById('adminSearchResults').style.display = 'none';
      document.getElementById('adminSearch').style.display = 'none';

      // Show selected info
      const infoDiv = document.getElementById('adminSelectedInfo');
      infoDiv.style.display = 'block';
      document.getElementById('adminSelectedName').textContent = `${player.prenom} ${player.nom}`;
      document.getElementById('adminSelectedLicence').textContent = `(${player.licence})`;
      document.getElementById('adminSelectedEmail').textContent = player.email || '-';
      document.getElementById('adminSelectedTelPort').textContent = player.tel_port || '-';
      document.getElementById('adminSelectedTelFixe').textContent = player.tel_fixe || '-';

      // Auto-fill admin username if not already set
      const usernameField = document.getElementById('adminUsername');
      if (!usernameField.value || usernameField.value.startsWith('admin')) {
        const cdbCode = document.getElementById('orgFfbCode').value;
        usernameField.value = 'admin' + cdbCode;
      }
    }

    function clearAdminSelection() {
      selectedAdmin = null;
      document.getElementById('adminSelectedInfo').style.display = 'none';
      document.getElementById('adminSearch').style.display = 'block';
      document.getElementById('adminSearch').value = '';
      document.getElementById('adminSearch').focus();
    }

    // ==================== Create Form ====================
    function toggleCreateForm() {
      const form = document.getElementById('createForm');
      form.classList.toggle('visible');
      if (form.classList.contains('visible') && ffbCdbs.length === 0) {
        loadFfbCdbs();
      }
    }

    function autoSlug() {
      const shortName = document.getElementById('orgShortName').value;
      document.getElementById('orgSlug').value = shortName.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
    }

    async function createOrganization() {
      const data = {
        name: document.getElementById('orgName').value.trim(),
        short_name: document.getElementById('orgShortName').value.trim(),
        slug: document.getElementById('orgSlug').value.trim(),
        ffb_cdb_code: document.getElementById('orgFfbCode').value.trim(),
        ffb_ligue_numero: document.getElementById('orgLigue').value.trim(),
        admin_username: document.getElementById('adminUsername').value.trim(),
        admin_email: selectedAdmin?.email || '',
        admin_phone: selectedAdmin?.tel_port || selectedAdmin?.tel_fixe || '',
        admin_licence: selectedAdmin?.licence || '',
        admin_password: document.getElementById('adminPassword').value.trim()
      };

      if (!selectedAdmin) {
        showToast('Veuillez sélectionner un licencié FFB comme administrateur', 'error');
        return;
      }

      if (!data.name || !data.short_name || !data.slug || !data.admin_username || !data.admin_password) {
        showToast('Veuillez remplir tous les champs obligatoires', 'error');
        return;
      }

      const btn = document.getElementById('btnCreate');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Création...';

      try {
        const res = await authFetch(`${API_URL}/super-admin/organizations`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Erreur');

        const clubCount = result.clubs?.created || 0;
        const playerCount = result.players?.created || 0;
        const details = [clubCount > 0 ? `${clubCount} clubs` : '', playerCount > 0 ? `${playerCount} joueurs` : ''].filter(Boolean).join(', ');
        showToast(`Organisation "${data.short_name}" créée !${details ? ` (${details} importés)` : ''}`);
        currentOrgId = result.organization.id;

        // Hide create form, show summary + sync sections
        document.getElementById('createForm').classList.remove('visible');
        selectOrg(currentOrgId, data.short_name, data.slug, {
          clubs: clubCount,
          players: playerCount,
          admin: data.admin_username
        });

        // Reload table
        loadOrganizations();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Créer';
      }
    }

    // ==================== Select Org (show summary + sync sections) ====================
    function selectOrg(orgId, shortName, slug, stats) {
      currentOrgId = orgId;

      // Show summary section
      const baseUrl = window.location.origin;
      const loginUrl = `${baseUrl}/login.html?org=${slug}`;
      const playerAppUrl = `https://cdbhs-player-app-production.up.railway.app/?org=${slug}`;
      document.getElementById('orgSummarySection').classList.add('visible');
      document.getElementById('summaryOrgName').textContent = shortName;
      document.getElementById('summaryLoginUrl').value = loginUrl;
      document.getElementById('summaryPlayerAppUrl').value = playerAppUrl;
      document.getElementById('summaryClubs').textContent = stats?.clubs || '-';
      document.getElementById('summaryPlayers').textContent = stats?.players || '-';
      document.getElementById('summaryAdmin').textContent = stats?.admin || '-';

      // Show welcome email status
      const btn = document.getElementById('btnSendWelcome');
      const result = document.getElementById('welcomeResult');
      if (stats?.welcomeSent) {
        btn.textContent = 'Renvoyer l\'email de bienvenue';
        result.innerHTML = '<span style="color: #2e7d32;">Email de bienvenue déjà envoyé</span>';
      } else {
        btn.textContent = 'Envoyer l\'email de bienvenue';
        result.innerHTML = '<span style="color: #e65100; font-weight: 600;">Email de bienvenue non envoyé</span>';
      }

      // Show sync section
      document.getElementById('syncSection').classList.add('visible');
      document.getElementById('syncOrgName').textContent = shortName;
      document.getElementById('syncPreview').innerHTML = '';
      document.getElementById('syncResult').innerHTML = '';
      document.getElementById('btnSyncApply').style.display = 'none';
    }

    // ==================== Login URL + Welcome Email ====================
    function copyUrl(inputId) {
      const input = document.getElementById(inputId);
      input.select();
      navigator.clipboard.writeText(input.value);
      showToast('URL copiée !');
    }

    async function sendWelcomeEmail() {
      if (!currentOrgId) return;
      if (!confirm('Envoyer l\'email de bienvenue à l\'administrateur de ce CDB ?')) return;

      const btn = document.getElementById('btnSendWelcome');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Envoi...';

      try {
        const res = await authFetch(`${API_URL}/super-admin/organizations/${currentOrgId}/send-welcome`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur');

        document.getElementById('welcomeResult').innerHTML = `<span style="color: #28a745;">${data.message}</span>`;
        showToast(data.message);
        btn.textContent = 'Renvoyer l\'email de bienvenue';
        // Refresh table to update badge
        loadOrganizations();
      } catch (error) {
        document.getElementById('welcomeResult').innerHTML = `<span style="color: #dc3545;">${error.message}</span>`;
        showToast(error.message, 'error');
      } finally {
        btn.disabled = false;
      }
    }

    // ==================== Navigate to CDB Dashboard (impersonation) ====================
    async function goToDashboard(orgId, slug) {
      try {
        // Save the current SA token so we can come back
        const saToken = localStorage.getItem('token');
        localStorage.setItem('sa_token', saToken);

        // Get an impersonation token scoped to this CDB
        const res = await authFetch(`${API_URL}/super-admin/impersonate/${orgId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur');

        // Set the CDB-scoped token and update localStorage
        localStorage.setItem('token', data.token);
        localStorage.setItem('userRole', 'admin');
        localStorage.setItem('organizationId', orgId);
        localStorage.setItem('orgSlug', slug);
        localStorage.setItem('isSuperAdmin', 'true');
        sessionStorage.setItem('activeOrgSession', 'true');

        // Navigate to the CDB dashboard (token already contains the correct org)
        window.location.href = 'dashboard.html';
      } catch (error) {
        console.error('Impersonation error:', error);
        showToast('Erreur: ' + error.message, 'error');
      }
    }

    // ==================== Sync Players with FFB ====================
    async function previewSync() {
      if (!currentOrgId) return;
      const btn = document.getElementById('btnSyncPreview');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Analyse en cours...';

      try {
        const res = await authFetch(`${API_URL}/super-admin/organizations/${currentOrgId}/sync-preview`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur');

        const previewDiv = document.getElementById('syncPreview');
        const s = data.summary;

        let html = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 16px;">
          <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: #1565c0;">${s.ffb_total}</div>
            <div style="font-size: 11px; color: #666;">Licenciés FFB</div>
          </div>
          <div style="background: #f3e5f5; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: #7b1fa2;">${s.local_total}</div>
            <div style="font-size: 11px; color: #666;">Joueurs locaux</div>
          </div>
          <div style="background: #e8f5e9; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: #2e7d32;">${s.new_players}</div>
            <div style="font-size: 11px; color: #666;">Nouveaux</div>
          </div>
          <div style="background: #fff3e0; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: #e65100;">${s.changed}</div>
            <div style="font-size: 11px; color: #666;">Modifiés</div>
          </div>
          <div style="background: #f5f5f5; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: #666;">${s.unchanged}</div>
            <div style="font-size: 11px; color: #666;">Inchangés</div>
          </div>
        </div>`;

        // Changed players with field-level diffs
        if (data.changed.length > 0) {
          html += `<details open style="margin-bottom: 12px;">
            <summary style="cursor: pointer; font-weight: 600; font-size: 13px; color: #e65100; margin-bottom: 8px;">
              ${s.changed} joueur(s) avec des modifications
            </summary>
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
              <thead><tr style="background: #fff3e0;">
                <th style="padding: 6px 8px; text-align: left;">Joueur</th>
                <th style="padding: 6px 8px; text-align: left;">Champ</th>
                <th style="padding: 6px 8px; text-align: left;">Valeur actuelle</th>
                <th style="padding: 6px 8px; text-align: left;">Valeur FFB</th>
              </tr></thead><tbody>`;

          for (const p of data.changed) {
            const rowspan = p.diffs.length;
            p.diffs.forEach((d, i) => {
              html += `<tr style="border-bottom: 1px solid #f0f0f0;">`;
              if (i === 0) {
                html += `<td style="padding: 6px 8px; vertical-align: top;" rowspan="${rowspan}"><strong>${p.last_name} ${p.first_name}</strong><br><span style="font-size: 10px; color: #888;">${p.licence}</span></td>`;
              }
              html += `<td style="padding: 6px 8px;">${d.field}</td>
                <td style="padding: 6px 8px; color: #c62828; text-decoration: line-through;">${d.local || '<em>vide</em>'}</td>
                <td style="padding: 6px 8px; color: #2e7d32; font-weight: 600;">${d.ffb}</td>
              </tr>`;
            });
          }
          html += `</tbody></table></details>`;
        }

        // New players
        if (data.new_players.length > 0) {
          html += `<details style="margin-bottom: 12px;">
            <summary style="cursor: pointer; font-weight: 600; font-size: 13px; color: #2e7d32; margin-bottom: 8px;">
              ${s.new_players} nouveau(x) joueur(s) à créer
            </summary>
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
              <thead><tr style="background: #e8f5e9;">
                <th style="padding: 6px 8px; text-align: left;">Licence</th>
                <th style="padding: 6px 8px; text-align: left;">Nom</th>
                <th style="padding: 6px 8px; text-align: left;">Prénom</th>
                <th style="padding: 6px 8px; text-align: left;">Club</th>
              </tr></thead><tbody>`;
          data.new_players.forEach(p => {
            html += `<tr style="border-bottom: 1px solid #f0f0f0;">
              <td style="padding: 6px 8px;">${p.licence}</td>
              <td style="padding: 6px 8px;">${p.last_name}</td>
              <td style="padding: 6px 8px;">${p.first_name}</td>
              <td style="padding: 6px 8px;">${p.club || '-'}</td>
            </tr>`;
          });
          html += `</tbody></table></details>`;
        }

        // Not in FFB (informational)
        if (data.not_in_ffb.length > 0) {
          html += `<details style="margin-bottom: 12px;">
            <summary style="cursor: pointer; font-weight: 600; font-size: 13px; color: #888; margin-bottom: 8px;">
              ${s.not_in_ffb} joueur(s) locaux absents du fichier FFB (non supprimés)
            </summary>
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
              <thead><tr style="background: #f5f5f5;">
                <th style="padding: 6px 8px; text-align: left;">Licence</th>
                <th style="padding: 6px 8px; text-align: left;">Nom</th>
                <th style="padding: 6px 8px; text-align: left;">Prénom</th>
                <th style="padding: 6px 8px; text-align: left;">Club</th>
              </tr></thead><tbody>`;
          data.not_in_ffb.forEach(p => {
            html += `<tr style="border-bottom: 1px solid #f0f0f0;">
              <td style="padding: 6px 8px;">${p.licence}</td>
              <td style="padding: 6px 8px;">${p.last_name}</td>
              <td style="padding: 6px 8px;">${p.first_name}</td>
              <td style="padding: 6px 8px;">${p.club || '-'}</td>
            </tr>`;
          });
          html += `</tbody></table></details>`;
        }

        // No changes needed
        if (s.new_players === 0 && s.changed === 0) {
          html += `<div style="background: #e8f5e9; padding: 12px; border-radius: 8px; color: #2e7d32; text-align: center;">
            Tous les joueurs sont à jour avec le fichier FFB.
          </div>`;
        }

        previewDiv.innerHTML = html;

        // Show apply button only if there are changes
        if (s.new_players > 0 || s.changed > 0) {
          document.getElementById('btnSyncApply').style.display = 'inline-block';
        }
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Analyser les différences';
      }
    }

    async function executeSync() {
      if (!currentOrgId) return;
      if (!confirm('Appliquer la synchronisation FFB ? Les données des joueurs seront mises à jour.')) return;

      const btn = document.getElementById('btnSyncApply');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Synchronisation...';

      try {
        const res = await authFetch(`${API_URL}/super-admin/organizations/${currentOrgId}/sync-players`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur');

        document.getElementById('syncResult').innerHTML = `
          <div style="background: #d4edda; padding: 12px; border-radius: 8px; color: #155724;">
            <strong>Synchronisation terminée</strong><br>
            ${data.created} joueur(s) créé(s), ${data.updated} mis à jour, ${data.unchanged} inchangé(s)
            ${data.errors > 0 ? `, <span style="color: #dc3545;">${data.errors} erreur(s)</span>` : ''}
          </div>`;

        showToast(`Sync ${data.organization}: ${data.created} créés, ${data.updated} mis à jour`);
        document.getElementById('btnSyncApply').style.display = 'none';
        loadOrganizations();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Appliquer la synchronisation';
      }
    }

    // ==================== Toggle Active ====================
    async function toggleActive(orgId) {
      try {
        const res = await authFetch(`${API_URL}/super-admin/organizations/${orgId}/toggle-active`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur');
        showToast(data.message);
        loadOrganizations();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // ==================== Delete Organization ====================
    async function deleteOrg(orgId, shortName) {
      if (!confirm(`Supprimer définitivement "${shortName}" et toutes ses données (joueurs, clubs, tournois, inscriptions, utilisateurs) ?\n\nCette action est irréversible.`)) return;
      if (!confirm(`Dernière confirmation : êtes-vous sûr de vouloir supprimer "${shortName}" ?`)) return;

      try {
        const res = await authFetch(`${API_URL}/super-admin/organizations/${orgId}`, {
          method: 'DELETE'
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur');

        showToast(data.message);

        // Hide summary + sync sections if this org was selected
        if (currentOrgId === orgId) {
          currentOrgId = null;
          document.getElementById('orgSummarySection').classList.remove('visible');
          document.getElementById('syncSection').classList.remove('visible');
        }

        loadOrganizations();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // ==================== Init ====================
    loadOrganizations();
  </script>
  <div style="position: fixed; bottom: 8px; right: 12px; font-size: 10px; color: #bbb; z-index: 9999;">SA 1.0.2</div>
</body>
</html>
