<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plateforme Gestion des Tournois CDB - Ligues</title>
  <link rel="icon" type="image/png" href="images/FFB.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .sa-nav { display: flex; gap: 0; background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
    .sa-nav a {
      flex: 1; text-align: center; padding: 12px 8px; text-decoration: none; font-size: 13px; font-weight: 600;
      color: #666; border-bottom: 3px solid transparent; transition: all 0.2s;
    }
    .sa-nav a:hover { background: #f8f9fa; color: #333; }
    .sa-nav a.active { color: var(--color-primary, #1F4788); border-bottom-color: var(--color-primary, #1F4788); background: #f0f4ff; }
    .sa-nav a .nav-icon { display: block; font-size: 18px; margin-bottom: 2px; }

    .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card h3 { margin: 0 0 12px 0; font-size: 15px; color: #333; }

    .ligues-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .ligues-table th { background: #f5f5f5; padding: 8px 10px; text-align: left; font-size: 11px; text-transform: uppercase; color: #666; }
    .ligues-table td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
    .ligues-table tr:hover { background: #fafafa; }
    .ligues-table tr { cursor: pointer; }

    .ligue-logo { width: 36px; height: 36px; border-radius: 6px; object-fit: contain; background: #f5f5f5; }
    .ligue-logo-placeholder { width: 36px; height: 36px; border-radius: 6px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #ccc; }

    .stat-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; background: #e8f5e9; color: #2e7d32; margin-right: 4px; }
    .stat-badge.clubs { background: #e3f2fd; color: #1565c0; }
    .stat-badge.licences { background: #f3e5f5; color: #7b1fa2; }
    .stat-badge.cdbs { background: #fff3e0; color: #e65100; }

    .contact-info { font-size: 11px; color: #888; }
    .contact-info a { color: #1976d2; text-decoration: none; }
    .contact-info a:hover { text-decoration: underline; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9000; justify-content: center; align-items: center; }
    .modal-overlay.visible { display: flex; }
    .modal { background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 560px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
    .modal h3 { margin: 0 0 16px 0; font-size: 16px; color: #333; display: flex; justify-content: space-between; align-items: center; }
    .modal h3 .close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: #999; padding: 0 4px; }
    .modal h3 .close-btn:hover { color: #333; }

    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; color: #555; margin-bottom: 4px; }
    .form-group input { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; box-sizing: border-box; }
    .form-group input:focus { border-color: var(--color-primary, #1F4788); outline: none; box-shadow: 0 0 0 2px rgba(31,71,136,0.1); }
    .form-group textarea { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; box-sizing: border-box; resize: vertical; min-height: 60px; }

    /* Logo upload zone */
    .logo-zone { border: 2px dashed #ddd; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: border-color 0.2s; margin-bottom: 12px; }
    .logo-zone:hover { border-color: var(--color-primary, #1F4788); }
    .logo-zone.has-logo { border-style: solid; border-color: #e0e0e0; }
    .logo-zone img { max-height: 80px; max-width: 100%; border-radius: 6px; }
    .logo-zone .placeholder { color: #999; font-size: 13px; }
    .logo-zone .remove-btn { display: inline-block; margin-top: 8px; font-size: 11px; color: #dc3545; cursor: pointer; }
    .logo-zone .remove-btn:hover { text-decoration: underline; }

    .btn-sm { padding: 4px 12px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; }
    .btn-primary { background: var(--color-primary, #1F4788); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-outline { background: white; color: #333; border: 1px solid #ddd; }
    .btn-outline:hover { background: #f5f5f5; }
    .btn-lg { padding: 10px 24px; font-size: 14px; border-radius: 6px; }

    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; font-size: 14px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; }
    .toast.success { background: #28a745; }
    .toast.error { background: #dc3545; }
    .toast.visible { display: block; }

    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <div>
        <h2 style="margin-bottom: 0;"><img id="app-header-icon" src="images/FFB.png" alt="" style="height: 48px; width: 48px; vertical-align: middle; margin-right: 8px; border-radius: 6px;" onerror="this.src='images/FrenchBillard-Icon-small.png';"><span id="app-org-name" data-page-title="Super Admin">Plateforme Gestion des Tournois CDB</span></h2>
      </div>
      <div class="nav-links">
        <a href="#" id="logoutBtn" class="nav-logout">Déconnexion</a>
      </div>
    </div>

    <!-- Super Admin Navigation -->
    <nav class="sa-nav">
      <a href="super-admin.html">
        <span class="nav-icon">&#x1F4CA;</span>
        Tableau de bord
      </a>
      <a href="super-admin-cdbs.html">
        <span class="nav-icon">&#x1F3E2;</span>
        CDBs
      </a>
      <a href="super-admin-ligues.html" class="active">
        <span class="nav-icon">&#x1F3DB;</span>
        Ligues
      </a>
      <a href="super-admin-ffb.html">
        <span class="nav-icon">&#x1F4C1;</span>
        Données FFB
      </a>
      <a href="super-admin-ffb-browser.html">
        <span class="nav-icon">&#x1F50D;</span>
        FFB Fichiers
      </a>
      <a href="super-admin-users.html">
        <span class="nav-icon">&#x1F465;</span>
        Utilisateurs
      </a>
      <a href="super-admin-settings.html">
        <span class="nav-icon">&#x2699;</span>
        Paramètres
      </a>
    </nav>

    <div id="accessDenied" style="display: none; text-align: center; padding: 40px; color: #666;">
      <h3>Accès refusé</h3>
      <p>Cette page est réservée au Super Admin.</p>
      <a href="login.html?sa=1" class="btn" onclick="localStorage.clear();">Se reconnecter</a>
    </div>

    <div id="pageContent" style="display: none;">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0;">Ligues FFB <span id="ligueCount" style="font-weight: normal; color: #999; font-size: 13px;"></span></h3>
        </div>
        <p style="font-size: 12px; color: #888; margin: 0 0 12px 0;">Les ligues sont importées depuis les données FFB. Cliquez sur une ligue pour ajouter son logo et ses coordonnées.</p>
        <div style="overflow-x: auto;">
          <table class="ligues-table" id="liguesTable">
            <thead>
              <tr>
                <th style="width: 50px;">Logo</th>
                <th>Nom</th>
                <th>N°</th>
                <th>CDBs</th>
                <th>Clubs</th>
                <th>Licenciés</th>
                <th>Contact</th>
              </tr>
            </thead>
            <tbody id="liguesTbody">
              <tr><td colspan="7" style="text-align: center; color: #999;">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h3>
        <span id="modalTitle">Modifier la ligue</span>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </h3>

      <div class="form-group">
        <label>Logo de la ligue</label>
        <div class="logo-zone" id="logoZone" onclick="document.getElementById('logoInput').click()">
          <div class="placeholder" id="logoPlaceholder">Cliquez pour ajouter un logo (PNG, JPG)</div>
          <img id="logoPreview" style="display: none;">
          <span class="remove-btn" id="logoRemoveBtn" style="display: none;" onclick="event.stopPropagation(); removeLogo();">Supprimer le logo</span>
        </div>
        <input type="file" id="logoInput" accept="image/*" style="display: none;" onchange="onLogoSelected(this)">
      </div>

      <div class="form-group">
        <label>Email</label>
        <input type="email" id="editEmail" placeholder="contact@ligue.fr">
      </div>
      <div class="form-group">
        <label>Téléphone</label>
        <input type="tel" id="editTelephone" placeholder="01 23 45 67 89">
      </div>
      <div class="form-group">
        <label>Site web</label>
        <input type="url" id="editWebsite" placeholder="https://www.ligue.fr">
      </div>
      <div class="form-group">
        <label>Adresse</label>
        <textarea id="editAddress" placeholder="Adresse postale de la ligue"></textarea>
      </div>

      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button class="btn-sm btn-primary btn-lg" onclick="saveLigue()" id="btnSave">Enregistrer</button>
        <button class="btn-sm btn-outline btn-lg" onclick="closeModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script src="js/auth-utils.js"></script>
  <script>
    const API_URL = '/api';
    if (!requireAuth()) throw new Error('Not authenticated');
    const token = localStorage.getItem('token');
    if (localStorage.getItem('isSuperAdmin') !== 'true') {
      document.getElementById('accessDenied').style.display = 'block';
      throw new Error('Not super admin');
    }
    document.getElementById('pageContent').style.display = 'block';
    document.getElementById('logoutBtn').addEventListener('click', (e) => { e.preventDefault(); logout(); });

    // State
    let currentLigue = null;
    let newLogoFile = null;
    let logoRemoved = false;

    // ==================== Toast ====================
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} visible`;
      setTimeout(() => toast.classList.remove('visible'), 4000);
    }

    // ==================== Load Ligues ====================
    async function loadLigues() {
      try {
        const res = await authFetch(`${API_URL}/super-admin/ligues`);
        const ligues = await res.json();
        const tbody = document.getElementById('liguesTbody');
        document.getElementById('ligueCount').textContent = `(${ligues.length})`;

        if (ligues.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Aucune ligue. Importez les données FFB d\'abord.</td></tr>';
          return;
        }

        tbody.innerHTML = ligues.map(l => {
          const logoHtml = l.has_logo
            ? `<img src="${API_URL}/super-admin/ligues/${l.numero}/logo?t=${Date.now()}" class="ligue-logo" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="ligue-logo-placeholder" style="display:none;">&#x1F3DB;</div>`
            : `<div class="ligue-logo-placeholder">&#x1F3DB;</div>`;

          const contactParts = [];
          if (l.email) contactParts.push(`<a href="mailto:${l.email}">${l.email}</a>`);
          if (l.telephone) contactParts.push(l.telephone);
          if (l.website) contactParts.push(`<a href="${l.website}" target="_blank">Site web</a>`);
          const contactHtml = contactParts.length > 0
            ? `<div class="contact-info">${contactParts.join(' · ')}</div>`
            : '<span style="color: #ccc; font-size: 11px;">Non renseigné</span>';

          return `<tr onclick="openEdit('${l.numero}')">
            <td>${logoHtml}</td>
            <td><strong>${l.nom || 'Ligue ' + l.numero}</strong></td>
            <td>${l.numero}</td>
            <td><span class="stat-badge cdbs">${l.cdb_count}</span></td>
            <td><span class="stat-badge clubs">${l.club_count}</span></td>
            <td><span class="stat-badge licences">${parseInt(l.licence_count).toLocaleString('fr-FR')}</span></td>
            <td>${contactHtml}</td>
          </tr>`;
        }).join('');
      } catch (error) {
        console.error('Error loading ligues:', error);
        showToast('Erreur de chargement', 'error');
      }
    }

    // ==================== Edit Modal ====================
    async function openEdit(numero) {
      try {
        const res = await authFetch(`${API_URL}/super-admin/ligues`);
        const ligues = await res.json();
        currentLigue = ligues.find(l => String(l.numero) === String(numero));
        if (!currentLigue) return;

        newLogoFile = null;
        logoRemoved = false;

        document.getElementById('modalTitle').textContent = currentLigue.nom || 'Ligue ' + numero;
        document.getElementById('editEmail').value = currentLigue.email || '';
        document.getElementById('editTelephone').value = currentLigue.telephone || '';
        document.getElementById('editWebsite').value = currentLigue.website || '';
        document.getElementById('editAddress').value = currentLigue.address || '';

        // Logo preview
        const preview = document.getElementById('logoPreview');
        const placeholder = document.getElementById('logoPlaceholder');
        const removeBtn = document.getElementById('logoRemoveBtn');
        const zone = document.getElementById('logoZone');

        if (currentLigue.has_logo) {
          preview.src = `${API_URL}/super-admin/ligues/${numero}/logo?t=${Date.now()}`;
          preview.style.display = 'block';
          placeholder.style.display = 'none';
          removeBtn.style.display = 'inline-block';
          zone.classList.add('has-logo');
        } else {
          preview.style.display = 'none';
          placeholder.style.display = 'block';
          removeBtn.style.display = 'none';
          zone.classList.remove('has-logo');
        }

        document.getElementById('logoInput').value = '';
        document.getElementById('editModal').classList.add('visible');
      } catch (error) {
        console.error('Error opening edit:', error);
        showToast('Erreur', 'error');
      }
    }

    function closeModal() {
      document.getElementById('editModal').classList.remove('visible');
      currentLigue = null;
      newLogoFile = null;
      logoRemoved = false;
    }

    function onLogoSelected(input) {
      if (!input.files || !input.files[0]) return;
      newLogoFile = input.files[0];
      logoRemoved = false;

      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('logoPreview');
        preview.src = e.target.result;
        preview.style.display = 'block';
        document.getElementById('logoPlaceholder').style.display = 'none';
        document.getElementById('logoRemoveBtn').style.display = 'inline-block';
        document.getElementById('logoZone').classList.add('has-logo');
      };
      reader.readAsDataURL(newLogoFile);
    }

    async function removeLogo() {
      if (currentLigue && currentLigue.has_logo && !newLogoFile) {
        // Mark for deletion on save
        logoRemoved = true;
      }
      newLogoFile = null;
      document.getElementById('logoPreview').style.display = 'none';
      document.getElementById('logoPlaceholder').style.display = 'block';
      document.getElementById('logoRemoveBtn').style.display = 'none';
      document.getElementById('logoZone').classList.remove('has-logo');
      document.getElementById('logoInput').value = '';
    }

    // ==================== Save ====================
    async function saveLigue() {
      if (!currentLigue) return;

      const btn = document.getElementById('btnSave');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Enregistrement...';

      try {
        // Delete logo first if marked for removal
        if (logoRemoved) {
          await authFetch(`${API_URL}/super-admin/ligues/${currentLigue.numero}/logo`, { method: 'DELETE' });
        }

        // Save contacts + optional new logo via FormData
        const formData = new FormData();
        formData.append('email', document.getElementById('editEmail').value.trim());
        formData.append('telephone', document.getElementById('editTelephone').value.trim());
        formData.append('website', document.getElementById('editWebsite').value.trim());
        formData.append('address', document.getElementById('editAddress').value.trim());
        if (newLogoFile) {
          formData.append('logo', newLogoFile);
        }

        const res = await authFetch(`${API_URL}/super-admin/ligues/${currentLigue.numero}`, {
          method: 'PUT',
          body: formData
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur');

        showToast(data.message || 'Ligue mise à jour');
        closeModal();
        loadLigues();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Enregistrer';
      }
    }

    // Close modal on overlay click
    document.getElementById('editModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('editModal')) closeModal();
    });

    // ==================== Init ====================
    loadLigues();
  </script>
  <div style="position: fixed; bottom: 8px; right: 12px; font-size: 10px; color: #bbb; z-index: 9999;">SA 1.0.1</div>
</body>
</html>
