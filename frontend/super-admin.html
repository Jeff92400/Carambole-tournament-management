<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plateforme Gestion des Tournois CDB</title>
  <link rel="icon" type="image/png" href="images/FFB.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .sa-nav { display: flex; gap: 0; background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
    .sa-nav a {
      flex: 1; text-align: center; padding: 12px 8px; text-decoration: none; font-size: 13px; font-weight: 600;
      color: #666; border-bottom: 3px solid transparent; transition: all 0.2s;
    }
    .sa-nav a:hover { background: #f8f9fa; color: #333; }
    .sa-nav a.active { color: var(--color-primary, #1F4788); border-bottom-color: var(--color-primary, #1F4788); background: #f0f4ff; }
    .sa-nav a .nav-icon { display: block; font-size: 18px; margin-bottom: 2px; }
    .compact-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 10px; }
    .compact-stat {
      padding: 12px; border-radius: 12px; text-align: center; color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 10px 28px rgba(0,0,0,0.12);
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .compact-stat:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.18), 0 16px 36px rgba(0,0,0,0.14);
    }
    .compact-stat h5 { margin: 0 0 4px 0; font-size: 11px; opacity: 0.9; text-transform: uppercase; }
    .compact-stat .val { font-size: 28px; font-weight: bold; line-height: 1; }
    .section-title { font-size: 13px; color: #666; margin: 12px 0 8px 0; font-weight: bold; text-transform: uppercase; }
    .progress-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .progress-item {
      display: flex; align-items: center; gap: 10px; padding: 8px 0;
      border-bottom: 1px solid #f0f0f0; font-size: 14px;
    }
    .progress-item:last-child { border-bottom: none; }
    .progress-icon { font-size: 18px; width: 24px; text-align: center; }
    .progress-label { flex: 1; color: #333; }
    .progress-badge {
      padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;
    }
    .badge-done { background: #d4edda; color: #155724; }
    .badge-pending { background: #f8d7da; color: #721c24; }
    .ffb-status-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .ffb-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 14px; }
    .ffb-label { color: #666; }
    .ffb-value { font-weight: bold; color: #333; }
    .users-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .users-table th { background: #f5f5f5; padding: 8px 10px; text-align: left; font-size: 11px; text-transform: uppercase; color: #666; }
    .users-table td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; }
    .users-table tr:hover { background: #fafafa; }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <div>
        <h2 style="margin-bottom: 0;"><img id="app-header-icon" src="images/FFB.png" alt="" style="height: 48px; width: 48px; vertical-align: middle; margin-right: 8px; border-radius: 6px;" onerror="this.src='images/FrenchBillard-Icon-small.png';"><span id="app-org-name" data-page-title="Super Admin">Plateforme Gestion des Tournois CDB</span></h2>
      </div>
      <div class="nav-links">
        <a href="#" id="logoutBtn" class="nav-logout">Déconnexion</a>
      </div>
    </div>

    <!-- Super Admin Navigation -->
    <nav class="sa-nav">
      <a href="super-admin.html" class="active">
        <span class="nav-icon">&#x1F4CA;</span>
        Tableau de bord
      </a>
      <a href="super-admin-cdbs.html">
        <span class="nav-icon">&#x1F3E2;</span>
        CDBs
      </a>
      <a href="super-admin-ligues.html">
        <span class="nav-icon">&#x1F3DB;</span>
        Ligues
      </a>
      <a href="super-admin-ffb.html">
        <span class="nav-icon">&#x1F4C1;</span>
        Données FFB
      </a>
      <a href="super-admin-ffb-browser.html">
        <span class="nav-icon">&#x1F50D;</span>
        FFB Fichiers
      </a>
      <a href="super-admin-users.html">
        <span class="nav-icon">&#x1F465;</span>
        Utilisateurs
      </a>
      <a href="super-admin-settings.html">
        <span class="nav-icon">&#x2699;</span>
        Paramètres
      </a>
    </nav>

    <div id="accessDenied" style="display: none; text-align: center; padding: 40px; color: #666;">
      <h3>Accès refusé</h3>
      <p>Cette page est réservée au Super Admin.</p>
      <a href="login.html?sa=1" class="btn" onclick="localStorage.clear();">Se reconnecter</a>
    </div>

    <div id="dashboardContent" style="display: none;">
      <!-- FFB File Data -->
      <div class="section-title">Données fichier FFB</div>
      <div class="compact-stats">
        <div class="compact-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h5>Ligues</h5>
          <div class="val" id="kpiLigues">-</div>
        </div>
        <div class="compact-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h5>CDBs</h5>
          <div class="val" id="kpiCdbs">-</div>
        </div>
        <div class="compact-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h5>Clubs</h5>
          <div class="val" id="kpiClubs">-</div>
        </div>
        <div class="compact-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h5>Licences</h5>
          <div class="val" id="kpiLicences">-</div>
        </div>
      </div>
      <div class="ffb-status-card" id="lastImportCard" style="display: none;">
        <div class="ffb-row">
          <span class="ffb-label">Dernier import</span>
          <span class="ffb-value" id="lastImportInfo">-</span>
        </div>
      </div>

      <!-- Platform Stats -->
      <div class="section-title">Plateforme</div>
      <div class="compact-stats">
        <div class="compact-stat" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
          <h5>CDBs actifs</h5>
          <div class="val" id="kpiPlatformCdbs">-</div>
        </div>
        <div class="compact-stat" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
          <h5>Joueurs</h5>
          <div class="val" id="kpiPlatformPlayers">-</div>
        </div>
        <div class="compact-stat" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
          <h5>Clubs</h5>
          <div class="val" id="kpiPlatformClubs">-</div>
        </div>
        <div class="compact-stat" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
          <h5>Tournois</h5>
          <div class="val" id="kpiPlatformTournaments">-</div>
        </div>
        <div class="compact-stat" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
          <h5>Admins</h5>
          <div class="val" id="kpiPlatformUsers">-</div>
        </div>
      </div>

      <!-- Pending welcome emails alert -->
      <div id="pendingWelcomeAlert" style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 20px;">&#9993;</span>
          <div style="flex: 1;">
            <strong style="color: #856404;">Emails de bienvenue en attente</strong>
            <div id="pendingWelcomeList" style="font-size: 13px; color: #856404; margin-top: 4px;"></div>
          </div>
          <a href="super-admin-cdbs.html" class="btn-sm btn-primary" style="white-space: nowrap;">Aller aux CDBs</a>
        </div>
      </div>

      <!-- CDB Enrolments -->
      <div class="section-title">Inscriptions CDB <span id="enrolmentCount" style="font-weight: normal; color: #999;"></span></div>
      <div class="progress-card" style="overflow-x: auto;">
        <table class="users-table">
          <thead>
            <tr>
              <th>#</th>
              <th>CDB</th>
              <th>Ligue</th>
              <th>Code FFB</th>
              <th>Joueurs</th>
              <th>Clubs</th>
              <th>Utilisateurs</th>
              <th>Statut</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="enrolmentsBody">
            <tr><td colspan="9" style="text-align: center; color: #999;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <script src="js/auth-utils.js?v=197"></script>
  <script>
    const API_URL = '/api';

    if (!requireAuth()) {
      throw new Error('Not authenticated');
    }
    const token = localStorage.getItem('token');

    // Check super admin access
    const isSuperAdmin = localStorage.getItem('isSuperAdmin') === 'true';
    if (!isSuperAdmin) {
      document.getElementById('accessDenied').style.display = 'block';
      throw new Error('Not super admin');
    }

    document.getElementById('dashboardContent').style.display = 'block';

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      logout();
    });

    // Format date for display
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function formatDateShort(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        const response = await authFetch(`${API_URL}/super-admin/dashboard`);
        if (response.status === 403) {
          document.getElementById('dashboardContent').style.display = 'none';
          document.getElementById('accessDenied').style.display = 'block';
          return;
        }
        const data = await response.json();

        // FFB file KPIs
        const ffb = data.ffb_file;
        document.getElementById('kpiLigues').textContent = ffb.ligues.toLocaleString('fr-FR');
        document.getElementById('kpiCdbs').textContent = ffb.cdbs.toLocaleString('fr-FR');
        document.getElementById('kpiClubs').textContent = ffb.clubs.toLocaleString('fr-FR');
        document.getElementById('kpiLicences').textContent = ffb.licences.toLocaleString('fr-FR');

        // Last import
        if (ffb.last_import) {
          document.getElementById('lastImportCard').style.display = 'block';
          document.getElementById('lastImportInfo').textContent =
            `${ffb.last_import.file_type} — ${ffb.last_import.record_count.toLocaleString('fr-FR')} enregistrements — ${formatDate(ffb.last_import.imported_at)}`;
        }

        // Platform stats
        const pf = data.platform;
        document.getElementById('kpiPlatformCdbs').textContent = pf.cdbs.toLocaleString('fr-FR');
        document.getElementById('kpiPlatformPlayers').textContent = pf.players.toLocaleString('fr-FR');
        document.getElementById('kpiPlatformClubs').textContent = pf.clubs.toLocaleString('fr-FR');
        document.getElementById('kpiPlatformTournaments').textContent = pf.tournaments.toLocaleString('fr-FR');
        document.getElementById('kpiPlatformUsers').textContent = pf.users.toLocaleString('fr-FR');

        // CDB enrolments table
        const enrolments = data.enrolments;
        document.getElementById('enrolmentCount').textContent = `(${enrolments.length})`;
        const tbody = document.getElementById('enrolmentsBody');

        if (!enrolments.length) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#999;">Aucun CDB inscrit</td></tr>';
          return;
        }

        // Show pending welcome email alert
        const pendingWelcome = enrolments.filter(o => !o.welcome_email_sent_at && o.is_active);
        if (pendingWelcome.length > 0) {
          document.getElementById('pendingWelcomeAlert').style.display = 'block';
          document.getElementById('pendingWelcomeList').textContent =
            pendingWelcome.map(o => o.short_name).join(', ') + ` (${pendingWelcome.length})`;
        }

        tbody.innerHTML = enrolments.map((org, idx) => {
          const statusBadge = org.is_active
            ? '<span class="progress-badge badge-done">Actif</span>'
            : '<span class="progress-badge badge-pending">Inactif</span>';
          return `<tr>
            <td><strong>${idx + 1}</strong></td>
            <td><strong>${org.short_name}</strong><br><span style="font-size:11px;color:#888;">${org.name}</span></td>
            <td>${org.ligue_nom || '-'}</td>
            <td>${org.ffb_cdb_code || '-'}</td>
            <td>${parseInt(org.player_count).toLocaleString('fr-FR')}</td>
            <td>${parseInt(org.club_count)}</td>
            <td>${parseInt(org.user_count)}</td>
            <td>${statusBadge}</td>
            <td>${formatDateShort(org.created_at)}</td>
          </tr>`;
        }).join('');

      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Initialize
    loadDashboard();
  </script>
  <div style="position: fixed; bottom: 8px; right: 12px; font-size: 10px; color: #bbb; z-index: 9999;">SA 1.0.2</div>
</body>
</html>
