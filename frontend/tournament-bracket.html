<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau &amp; Classement - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/FrenchBillard-Icon-small.png">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/branding.js"></script>
  <style>
    .bracket-section { margin-bottom: 30px; }
    .bracket-section h3 { margin-bottom: 15px; color: var(--color-primary, #1F4788); }

    .match-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .match-card.finale { border-left: 4px solid #ffc107; }
    .match-card.petite-finale { border-left: 4px solid #6c757d; }
    .match-card.semi-finale { border-left: 4px solid var(--color-primary, #1F4788); }
    .match-card.classification { border-left: 4px solid #17a2b8; }

    .match-label {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 10px;
      color: #333;
    }

    .match-players {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .match-player {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      flex-wrap: wrap;
    }
    .match-player.winner { background: #d4edda; font-weight: 600; }

    .match-player .player-name {
      flex: 1;
      min-width: 150px;
      font-size: 14px;
    }

    .match-player input {
      width: 60px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
    }

    .match-player label {
      font-size: 12px;
      color: #666;
      min-width: 35px;
    }

    .match-vs {
      text-align: center;
      font-size: 12px;
      color: #999;
      font-weight: 500;
    }

    .winner-btn {
      padding: 4px 10px;
      border: 1px solid #28a745;
      background: white;
      color: #28a745;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .winner-btn.selected {
      background: #28a745;
      color: white;
    }

    .bracket-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .single-poule-standings td, .single-poule-standings th {
      padding: 8px 12px;
    }

    .position-badge {
      display: inline-block;
      width: 28px;
      height: 28px;
      line-height: 28px;
      text-align: center;
      border-radius: 50%;
      font-weight: 700;
      font-size: 13px;
      color: white;
    }
    .position-badge.p1 { background: #FFD700; color: #333; }
    .position-badge.p2 { background: #C0C0C0; color: #333; }
    .position-badge.p3 { background: #CD7F32; }
    .position-badge.p4 { background: #6c757d; }

    .bye-player {
      padding: 10px 15px;
      background: #e7f3ff;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 12px;
    }

    @media (max-width: 768px) {
      .bracket-grid { grid-template-columns: 1fr; }
      .match-player { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img id="app-header-icon" src="images/FrenchBillard-Icon-small.png" alt="" style="height: 48px; width: 48px; vertical-align: middle; margin-right: 8px;" onerror="this.src='images/FrenchBillard-Icon-small.png';"><span id="app-org-name" data-page-title="Tableau & Classement">CDB</span></h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html" class="nav-tooltip" data-tooltip="Classement par catégorie">Classements</a>
        <a href="generate-poules.html" class="not-club nav-tooltip" data-tooltip="Compétitions à jouer / Convocations">Compétitions</a>
        <a href="settings.html" class="admin-only nav-tooltip" data-tooltip="Réservé aux administrateurs">Paramètres</a>
        <a href="#" id="logoutBtn" class="nav-logout">Déconnexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <div id="loadingSpinner" class="loading">
      <div class="spinner"></div>
      Chargement...
    </div>

    <div id="mainContent" style="display: none;">

      <!-- Back link -->
      <div style="margin-bottom: 15px;">
        <a id="backLink" href="tournaments-list.html" class="btn" style="background: #6c757d; text-decoration: none; font-size: 13px; padding: 8px 16px;">
          ← Retour aux tournois
        </a>
      </div>

      <!-- Tournament info -->
      <div class="card">
        <h3 id="tournamentTitle" style="margin-bottom: 10px;">-</h3>
        <div class="filter-section">
          <div class="form-group">
            <label>Joueurs</label>
            <div style="padding: 8px 0; font-weight: 500;" id="playerCount">-</div>
          </div>
          <div class="form-group">
            <label>Mode</label>
            <div style="padding: 8px 0; font-weight: 500;" id="bracketMode">-</div>
          </div>
        </div>
      </div>

      <!-- Single poule result (< 6 players) -->
      <div id="singlePouleSection" class="card" style="display: none;">
        <h3>Poule unique — Classement final</h3>
        <p style="color: #666; margin-bottom: 15px;">Moins de 6 joueurs : pas de tableau, le classement de la poule est le résultat final.</p>
        <table class="single-poule-standings" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: var(--color-primary, #1F4788); color: white;">
              <th>Pos.</th><th>Joueur</th><th>Pts Match</th><th>Points</th><th>Reprises</th>
            </tr>
          </thead>
          <tbody id="singlePouleBody"></tbody>
        </table>
        <div style="margin-top: 20px;">
          <button onclick="finalizeSinglePoule()" class="btn" style="background: #28a745; padding: 12px 25px;">
            Finaliser les positions
          </button>
        </div>
      </div>

      <!-- Bracket section (>= 6 players) -->
      <div id="bracketSection" style="display: none;">

        <!-- Qualifiers summary -->
        <div class="card bracket-section">
          <h3>Qualifiés pour le tableau</h3>
          <div id="qualifiersList" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>

        <!-- Semi-finals -->
        <div class="card bracket-section">
          <h3>Demi-finales</h3>
          <div class="bracket-grid" id="semiFinals"></div>
        </div>

        <!-- Finale + Petite Finale -->
        <div class="card bracket-section" id="finalesSection" style="display: none;">
          <h3>Finales</h3>
          <div class="bracket-grid" id="finales"></div>
        </div>

        <!-- Classification -->
        <div class="card bracket-section" id="classificationSection" style="display: none;">
          <h3>Matchs de classement</h3>
          <div id="byeInfo"></div>
          <div id="classificationR1"></div>
          <div id="classificationR2" style="margin-top: 20px;"></div>
        </div>

        <!-- Actions -->
        <div class="card" id="actionsSection">
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <button onclick="saveAllMatches()" class="btn" style="background: var(--color-primary, #1F4788); padding: 12px 25px;">
              Enregistrer les résultats
            </button>
            <button onclick="finalizePositions()" class="btn" style="background: #28a745; padding: 12px 25px;">
              Finaliser les positions
            </button>
          </div>
          <div id="actionMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
        </div>
      </div>

    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script src="js/app-branding.js"></script>
  <script>
    const API_URL = '/api';

    if (!requireAuth()) { throw new Error('Not authenticated'); }
    const token = localStorage.getItem('token');

    // State
    let bracketData = null;
    let tournamentId = null;

    // ==================== INIT ====================

    async function init() {
      const params = new URLSearchParams(window.location.search);
      tournamentId = parseInt(params.get('id'));

      if (!tournamentId) {
        showError('ID de tournoi manquant');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/bracket/${tournamentId}/setup`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const err = await response.json();
          showError(err.error || 'Erreur lors du chargement');
          return;
        }

        bracketData = await response.json();

        document.getElementById('tournamentTitle').textContent =
          `Tournoi #${tournamentId}`;
        document.getElementById('playerCount').textContent =
          `${bracketData.totalPlayers} joueurs`;

        if (bracketData.mode === 'single_poule') {
          document.getElementById('bracketMode').textContent = 'Poule unique';
          renderSinglePoule(bracketData.finalStandings);
        } else {
          document.getElementById('bracketMode').textContent =
            `Tableau ${bracketData.qualifiers.length} qualifiés`;
          renderBracket(bracketData);
        }

        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

      } catch (error) {
        console.error('Error:', error);
        showError('Erreur de connexion au serveur');
      }
    }

    function showError(msg) {
      document.getElementById('loadingSpinner').style.display = 'none';
      const errDiv = document.getElementById('errorMessage');
      errDiv.textContent = msg;
      errDiv.style.display = 'block';
    }

    function showActionMessage(msg, isSuccess) {
      const div = document.getElementById('actionMessage');
      div.textContent = msg;
      div.style.background = isSuccess ? '#d4edda' : '#f8d7da';
      div.style.color = isSuccess ? '#155724' : '#721c24';
      div.style.display = 'block';
      setTimeout(() => { div.style.display = 'none'; }, 4000);
    }

    // ==================== SINGLE POULE ====================

    function renderSinglePoule(standings) {
      document.getElementById('singlePouleSection').style.display = 'block';
      const tbody = document.getElementById('singlePouleBody');
      tbody.innerHTML = standings.map((p, i) => `
        <tr style="${i < 3 ? 'font-weight: 600;' : ''}">
          <td><span class="position-badge p${i + 1}">${i + 1}</span></td>
          <td>${p.playerName}</td>
          <td>${p.matchPoints}</td>
          <td>${p.points}</td>
          <td>${p.reprises}</td>
        </tr>
      `).join('');
    }

    async function finalizeSinglePoule() {
      // For single poule, save positions directly (no bracket matches)
      const standings = bracketData.finalStandings;
      const matches = standings.map((p, i) => ({
        phase: 'SINGLE',
        matchOrder: i + 1,
        matchLabel: `Position ${i + 1}`,
        player1Licence: p.licence,
        player1Name: p.playerName,
        player2Licence: null,
        player2Name: null,
        player1Points: p.points,
        player1Reprises: p.reprises,
        winnerLicence: p.licence,
        resultingPlace: i + 1,
      }));

      try {
        // Save matches
        await fetch(`${API_URL}/bracket/${tournamentId}/results`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ matches })
        });

        // Finalize
        const resp = await fetch(`${API_URL}/bracket/${tournamentId}/finalize`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        const result = await resp.json();

        if (resp.ok) {
          showActionMessage(`Positions finalisées : ${result.message}`, true);
        } else {
          showActionMessage(result.error || 'Erreur', false);
        }
      } catch (error) {
        showActionMessage('Erreur de connexion', false);
      }
    }

    // ==================== BRACKET RENDERING ====================

    function renderBracket(data) {
      document.getElementById('bracketSection').style.display = 'block';

      // Qualifiers summary
      const qualList = document.getElementById('qualifiersList');
      qualList.innerHTML = data.qualifiers.map(q => `
        <div style="padding: 8px 15px; background: #e7f3ff; border-radius: 6px; font-size: 14px;">
          <strong>${q.seed}.</strong> ${q.playerName}
          <span style="color: #666; font-size: 12px;">(${q.matchPoints} pts match)</span>
        </div>
      `).join('');

      // Check for existing saved matches
      const existing = data.existingMatches || [];
      const existingMap = {};
      for (const m of existing) {
        existingMap[`${m.phase}_${m.match_order}`] = m;
      }

      // Semi-finals
      const sfContainer = document.getElementById('semiFinals');
      const sfMatches = data.bracket.filter(m => m.phase === 'SF');
      sfContainer.innerHTML = sfMatches.map(m => {
        const saved = existingMap[`SF_${m.matchOrder}`];
        return renderMatchCard(m, 'semi-finale', saved);
      }).join('');

      // Finale + Petite Finale
      const fMatches = data.bracket.filter(m => m.phase === 'F' || m.phase === 'PF');
      if (fMatches.length > 0) {
        document.getElementById('finalesSection').style.display = 'block';
        const finalesContainer = document.getElementById('finales');
        finalesContainer.innerHTML = fMatches.map(m => {
          const cssClass = m.phase === 'F' ? 'finale' : 'petite-finale';
          const saved = existingMap[`${m.phase}_${m.matchOrder}`];
          return renderMatchCard(m, cssClass, saved);
        }).join('');
      }

      // Classification
      const classif = data.classification;
      if (classif && (classif.round1.length > 0 || classif.byePlayer)) {
        document.getElementById('classificationSection').style.display = 'block';

        if (classif.byePlayer) {
          document.getElementById('byeInfo').innerHTML = `
            <div class="bye-player">
              <strong>Exempt :</strong> ${classif.byePlayer.playerName}
              <span style="color: #666; font-size: 13px;">(meilleur non-qualifié — classé 5ème directement)</span>
            </div>`;
        }

        const r1Container = document.getElementById('classificationR1');
        r1Container.innerHTML = '<h4 style="margin-bottom: 10px; color: #555;">Tour 1</h4>' +
          classif.round1.map(m => {
            const saved = existingMap[`C_R1_${m.matchOrder}`];
            return renderMatchCard(m, 'classification', saved);
          }).join('');

        if (classif.round2 && classif.round2.length > 0) {
          const r2Container = document.getElementById('classificationR2');
          r2Container.innerHTML = '<h4 style="margin-bottom: 10px; color: #555;">Tour 2 (croisements)</h4>' +
            classif.round2.map(m => {
              const saved = existingMap[`C_R2_${m.matchOrder}`];
              return renderMatchCard(m, 'classification', saved);
            }).join('');
        }
      }
    }

    function renderMatchCard(match, cssClass, savedData) {
      const id = `${match.phase}_${match.matchOrder}`;
      const p1 = savedData || match;
      const hasPlayers = (p1.player1Licence || p1.player1_licence);

      const p1Licence = p1.player1Licence || p1.player1_licence || '';
      const p1Name = p1.player1Name || p1.player1_name || '(à déterminer)';
      const p2Licence = p1.player2Licence || p1.player2_licence || '';
      const p2Name = p1.player2Name || p1.player2_name || '(à déterminer)';
      const p1Pts = savedData ? (savedData.player1_points || 0) : 0;
      const p1Rep = savedData ? (savedData.player1_reprises || 0) : 0;
      const p2Pts = savedData ? (savedData.player2_points || 0) : 0;
      const p2Rep = savedData ? (savedData.player2_reprises || 0) : 0;
      const winner = savedData ? (savedData.winner_licence || '') : '';

      return `
        <div class="match-card ${cssClass}" data-match-id="${id}" data-phase="${match.phase}" data-order="${match.matchOrder}">
          <div class="match-label">${match.matchLabel}</div>
          <div class="match-players">
            <div class="match-player ${winner === p1Licence ? 'winner' : ''}" data-licence="${p1Licence}">
              <span class="player-name">${p1Name}</span>
              ${hasPlayers ? `
                <label>Pts</label>
                <input type="number" class="p1-points" value="${p1Pts}" min="0">
                <label>Rep</label>
                <input type="number" class="p1-reprises" value="${p1Rep}" min="0">
                <button class="winner-btn ${winner === p1Licence ? 'selected' : ''}"
                  onclick="setWinner(this, '${id}', '${p1Licence}')" title="Désigner vainqueur">V</button>
              ` : ''}
            </div>
            <div class="match-vs">VS</div>
            <div class="match-player ${winner === p2Licence ? 'winner' : ''}" data-licence="${p2Licence}">
              <span class="player-name">${p2Name}</span>
              ${hasPlayers && p2Licence ? `
                <label>Pts</label>
                <input type="number" class="p2-points" value="${p2Pts}" min="0">
                <label>Rep</label>
                <input type="number" class="p2-reprises" value="${p2Rep}" min="0">
                <button class="winner-btn ${winner === p2Licence ? 'selected' : ''}"
                  onclick="setWinner(this, '${id}', '${p2Licence}')" title="Désigner vainqueur">V</button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function setWinner(btn, matchId, licence) {
      const card = btn.closest('.match-card');
      // Toggle winner buttons
      card.querySelectorAll('.winner-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      // Highlight winner row
      card.querySelectorAll('.match-player').forEach(row => row.classList.remove('winner'));
      btn.closest('.match-player').classList.add('winner');
      // Store winner
      card.dataset.winner = licence;
    }

    // ==================== SAVE & FINALIZE ====================

    function collectMatches() {
      const matches = [];
      document.querySelectorAll('.match-card').forEach(card => {
        const phase = card.dataset.phase;
        const matchOrder = parseInt(card.dataset.order);
        const players = card.querySelectorAll('.match-player');
        const label = card.querySelector('.match-label')?.textContent || '';

        const p1 = players[0];
        const p2 = players.length > 1 ? players[1] : null;

        const p1Licence = p1?.dataset.licence || '';
        const p2Licence = p2?.dataset.licence || '';

        if (!p1Licence) return; // skip empty matches

        matches.push({
          phase,
          matchOrder,
          matchLabel: label,
          player1Licence: p1Licence,
          player1Name: p1?.querySelector('.player-name')?.textContent || '',
          player2Licence: p2Licence || null,
          player2Name: p2?.querySelector('.player-name')?.textContent || null,
          player1Points: parseInt(p1?.querySelector('.p1-points')?.value) || 0,
          player1Reprises: parseInt(p1?.querySelector('.p1-reprises')?.value) || 0,
          player2Points: parseInt(p2?.querySelector('.p2-points')?.value) || 0,
          player2Reprises: parseInt(p2?.querySelector('.p2-reprises')?.value) || 0,
          winnerLicence: card.dataset.winner || null,
        });
      });
      return matches;
    }

    async function saveAllMatches() {
      const matches = collectMatches();
      if (matches.length === 0) {
        showActionMessage('Aucun match à enregistrer', false);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/bracket/${tournamentId}/results`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ matches })
        });
        const data = await response.json();

        if (response.ok) {
          showActionMessage(data.message, true);
        } else {
          showActionMessage(data.error || 'Erreur', false);
        }
      } catch (error) {
        showActionMessage('Erreur de connexion', false);
      }
    }

    async function finalizePositions() {
      // First save matches
      await saveAllMatches();

      try {
        const response = await fetch(`${API_URL}/bracket/${tournamentId}/finalize`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (response.ok) {
          showActionMessage(`Positions finalisées : ${data.message}`, true);
        } else {
          showActionMessage(data.error || 'Erreur lors de la finalisation', false);
        }
      } catch (error) {
        showActionMessage('Erreur de connexion', false);
      }
    }

    // ==================== START ====================
    init();
  </script>
</body>
</html>
